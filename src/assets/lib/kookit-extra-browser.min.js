import e from"axios";import{Storage as t}from"megajs";import{Buffer as o}from"buffer";import{createClient as r,AuthType as i}from"webdav/dist/web/index.js";import{isElectron as n}from"react-device-detect";function a(e,t,o,r){return new(o||(o=Promise))((function(i,n){function a(e){try{l(r.next(e))}catch(e){n(e)}}function s(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,s)}l((r=r.apply(e,t||[])).next())}))}const s={publicUrl:"https://api.960960.xyz",cloudUrl:"https://cloud.960960.xyz",devUrl:"http://192.168.28.159:8000"},l={callbackUrl:"https://web.koodoreader.com/",dropboxClientId:"vnc67byrssocvy1",pcloudClientId:"pg8ten0B3vH",boxClientId:"ltimecqanmpxoaicn9qw3es6l3sdl1ya",microsoftClientId:"506df58a-29ab-4020-afc5-6f423dc80f35",googleClientId:"1051055003225-ph1f5fvh328dhv7bco5jitlnfhg6ks2t.apps.googleusercontent.com",facebookClientId:"2845583825559500",githubClientId:"Ov23liJVzfvJMMEEZ8v2",adriveClientId:"a128ae7b9c094545af623de61dc0a1ef"};var c={CloudConfig:s,ThirdpartyConfig:l,LoginAuthRequest:{google:{clientId:l.googleClientId,scopes:["openid"],usePKCE:!1,responseType:"code",redirectUri:l.callbackUrl,extraParams:{prompt:"consent",scope:"openid"}},microsoft:{clientId:l.microsoftClientId,scopes:["openid","profile","User.Read","offline_access"],usePKCE:!1,responseType:"code",redirectUri:l.callbackUrl,extraParams:{scope:"openid profile User.Read offline_access"}},facebook:{clientId:l.facebookClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:l.callbackUrl,extraParams:{scope:""}},github:{clientId:l.githubClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:l.callbackUrl,extraParams:{scope:""}}},LoginDiscovery:{microsoft:{authorizationEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/token"},google:{authorizationEndpoint:"https://accounts.google.com/o/oauth2/v2/auth",tokenEndpoint:"https://oauth2.googleapis.com/token"},facebook:{authorizationEndpoint:"https://www.facebook.com/v12.0/dialog/oauth",tokenEndpoint:"https://graph.facebook.com/v12.0/oauth/access_token"},github:{authorizationEndpoint:"https://github.com/login/oauth/authorize",tokenEndpoint:"https://github.com/login/oauth/access_token"}},DriveAuthRequest:{dropbox:{clientId:l.dropboxClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:l.callbackUrl,extraParams:{token_access_type:"offline"}},boxnet:{clientId:l.boxClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:l.callbackUrl,extraParams:{grant_type:"authorization_code",box_subject_type:"enterprise",scope:"root_readwrite"}},pcloud:{clientId:l.pcloudClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:l.callbackUrl,extraParams:{grant_type:"authorization_code"}},adrive:{clientId:l.adriveClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:l.callbackUrl,extraParams:{grant_type:"authorization_code",scope:"user:base,file:all:write,file:all:read"}},microsoft:{clientId:l.microsoftClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:l.callbackUrl,extraParams:{scope:"files.readwrite.appfolder offline_access"}},google:{clientId:l.googleClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:l.callbackUrl,extraParams:{prompt:"consent",scope:"https://www.googleapis.com/auth/drive.appdata",access_type:"offline"}}},DriveDiscovery:{dropbox:{authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",tokenEndpoint:"https://www.dropbox.com/oauth2/token"},boxnet:{authorizationEndpoint:"https://openapi.alipan.com/oauth/authorize",tokenEndpoint:"https://openapi.alipan.com/oauth/access_token "},pcloud:{authorizationEndpoint:"https://my.pcloud.com/oauth2/authorize",tokenEndpoint:"https://api.pcloud.com/oauth2_token"},adrive:{authorizationEndpoint:"https://openapi.alipan.com/oauth/authorize",tokenEndpoint:"https://openapi.alipan.com/oauth/token"},microsoft:{authorizationEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/token"},google:{authorizationEndpoint:"https://accounts.google.com/o/oauth2/v2/auth",tokenEndpoint:"https://oauth2.googleapis.com/token"}}};class d{constructor(e,t){this.config=e,this.thirdpartyRequest=t,this.driveId=""}getDriveId(){return a(this,void 0,void 0,(function*(){if(this.driveId)return this.driveId;const t=yield this.refreshToken(),o=yield e.post("https://openapi.alipan.com/adrive/v1.0/user/getDriveInfo",{},{headers:{Authorization:`Bearer ${t}`}});return this.driveId=o.data.default_drive_id,this.driveId}))}getFolderIdByPath(t){return a(this,void 0,void 0,(function*(){const o=yield this.refreshToken(),r=yield this.getDriveId();try{try{const i=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:r,file_path:t},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(i.data)return i.data.file_id}catch(i){const n=t.split("/").filter((e=>e));let a="",s="root";for(const t of n){a+="/"+t;try{s=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:r,file_path:a},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}})).data.file_id}catch(i){s=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/create",{drive_id:r,parent_file_id:s,name:t,type:"folder",check_name_mode:"refuse"},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}})).data.file_id}}return s}}catch(e){return console.log("Error getting/creating folder by path:",e),""}}))}listFiles(t){return a(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),r=yield this.getDriveId(),i=yield this.getFolderIdByPath("/KoodoReader/"+t);return(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/list",{drive_id:r,parent_file_id:i},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}})).data.items.map((e=>e.name))}catch(e){return console.log("Error listing files:",e),[]}}))}deleteFile(t){return a(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),r=yield this.getDriveId(),i=yield this.getFolderIdByPath("/KoodoReader/"+t);return!i||(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/delete",{drive_id:r,file_id:i},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}}),!0)}catch(e){return console.log("Error deleting file:",e),!1}}))}checkExists(t){var o;return a(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),i=yield this.getDriveId(),n=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:i,file_path:t},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});(null===(o=n.data)||void 0===o?void 0:o.file_id)&&(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/recyclebin/trash",{drive_id:i,file_id:n.data.file_id},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}))}catch(e){}}))}refreshToken(){return a(this,void 0,void 0,(function*(){if(console.log(this.config,"this.config"),this.config.access_token&&this.config.expires_at>(new Date).getTime())return this.config.access_token;let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"adrive",refresh_token:e});this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,this.config.refresh_token=t.data.refresh_token;let o=yield this.thirdpartyRequest.encryptToken({token:JSON.stringify({refresh_token:t.data.refresh_token})});return 200===o.code&&(yield this.thirdpartyRequest.TokenService.setToken("adrive_token",o.data.encrypted_token)),t.data.access_token}))}authToken(e){return a(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"adrive",redirect_uri:l.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://openapi.alipan.com/oauth/authorize?${new URLSearchParams({response_type:"code",client_id:l.adriveClientId,redirect_uri:l.callbackUrl,grant_type:"authorization_code",scope:"user:base,file:all:write,file:all:read"}).toString()}`}}class u extends d{constructor(e,t){super(e,t)}uploadFile(t,o){return a(this,void 0,void 0,(function*(){return new Promise(((r,i)=>a(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),n=yield this.getDriveId(),a=o.substring(0,o.lastIndexOf("/")),s=o.substring(o.lastIndexOf("/")+1),l=yield this.getFolderIdByPath("/KoodoReader/"+a),c=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/create",{drive_id:n,parent_file_id:l,name:s,type:"file",check_name_mode:"ignore"},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}),{file_id:d,upload_id:u,part_info_list:p}=c.data;yield e.put(p[0].upload_url,t,{headers:{"Content-Type":"application/octet-stream"}}),yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/complete",{drive_id:n,file_id:d,upload_id:u},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}}),r(!0)}catch(e){console.log("Error uploading file:",e),r(!1)}}))))}))}downloadFile(t){return new Promise(((o,r)=>a(this,void 0,void 0,(function*(){yield new Promise((e=>setTimeout(e,1e3)));try{const r=yield this.refreshToken(),i=yield this.getDriveId(),n=(yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/get_by_path",{drive_id:i,file_path:"/KoodoReader/"+t},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.file_id,a=yield e.post("https://openapi.alipan.com/adrive/v1.0/openFile/getDownloadUrl",{drive_id:i,file_id:n},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}),s=yield e.get(a.data.url,{responseType:"arraybuffer"});o(s.data)}catch(e){console.log("Error downloading file:",e),o(!1)}}))))}}class p{constructor(e,t){this.config=e,this.thirdpartyRequest=t}getFolderIdByPath(t){return a(this,void 0,void 0,(function*(){const o=yield this.refreshToken(),r=t.split("/");let i="0";for(const t of r){const r=`https://api.box.com/2.0/folders/${i}/items?fields=id,name&type=folder&limit=1000`;try{const n=(yield e.get(r,{headers:{Authorization:`Bearer ${o}`}})).data.entries.find((e=>e.name===t&&"folder"===e.type));if(n)i=n.id;else{const r={name:t,parent:{id:i},type:"folder"};i=(yield e.post("https://api.box.com/2.0/folders",r,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}})).data.id}}catch(e){return console.log("Error occurred during folder creation:",e),""}}return i}))}listFiles(t){return a(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken();let r=yield this.getFolderIdByPath("KoodoReader/"+t);return(yield e.get(`https://api.box.com/2.0/folders/${r}/items`,{headers:{Authorization:`Bearer ${o}`}})).data.entries.map((e=>e.name))}catch(e){return console.log("Error listing files:",e),[]}}))}deleteFile(t){return a(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),r=t.substring(0,t.lastIndexOf("/")),i=t.substring(t.lastIndexOf("/")+1),n=yield this.getFolderIdByPath("KoodoReader/"+r);if(!n)throw new Error("Folder not found");const a=`https://api.box.com/2.0/folders/${n}/items?fields=id,name&type=file&limit=1000`,s=(yield e.get(a,{headers:{Authorization:`Bearer ${o}`}})).data.entries.find((e=>e.name===i&&"file"===e.type));if(!s)throw new Error("File not found");return yield e.delete(`https://api.box.com/2.0/files/${s.id}`,{headers:{Authorization:`Bearer ${o}`}}),!0}catch(e){return console.log("Error deleting file:",e),!1}}))}refreshToken(){return a(this,void 0,void 0,(function*(){if(this.config.access_token&&this.config.expires_at>(new Date).getTime())return this.config.access_token;let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"boxnet",refresh_token:e});this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,this.config.refresh_token=t.data.refresh_token;let o=yield this.thirdpartyRequest.encryptToken({token:JSON.stringify({refresh_token:t.data.refresh_token})});return 200===o.code&&(yield this.thirdpartyRequest.TokenService.setToken("boxnet_token",o.data.encrypted_token)),t.data.access_token}))}authToken(e){return a(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"boxnet",redirect_uri:l.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://account.box.com/api/oauth2/authorize?${new URLSearchParams({response_type:"code",client_id:l.boxClientId,redirect_uri:l.callbackUrl,grant_type:"authorization_code",box_subject_type:"enterprise",scope:"root_readwrite"}).toString()}`}}class f extends p{constructor(e,t){super(e,t)}uploadFile(t,o){return new Promise(((r,i)=>a(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),n=o.substring(0,o.lastIndexOf("/")),a=o.substring(o.lastIndexOf("/")+1),s=yield this.getFolderIdByPath("KoodoReader/"+n);if(!s)throw new Error("Folder not found");let l=new File([t],a,{lastModified:(new Date).getTime(),type:t.type});const c=new FormData;c.append("file",l),c.append("parent_id",s);const d=yield e.post("https://upload.box.com/api/2.0/files/content",c,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"multipart/form-data"},maxContentLength:1/0,maxBodyLength:1/0});if(d.status>=300)return console.log("Error occurred during file upload:",d),void r(!1);r(!0)}catch(e){console.log("Error uploading file:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>a(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),i=t.substring(0,t.lastIndexOf("/")),n=t.substring(t.lastIndexOf("/")+1),a=yield this.getFolderIdByPath("KoodoReader/"+i);if(!a)throw new Error("Folder not found");const s=`https://api.box.com/2.0/folders/${a}/items?fields=id,name&type=file&limit=1000`,l=(yield e.get(s,{headers:{Authorization:`Bearer ${r}`}})).data.entries.find((e=>e.name===n&&"file"===e.type));if(!l)throw o(!1),new Error("File not found");const c=yield e({url:`https://api.box.com/2.0/files/${l.id}/content`,method:"get",headers:{Authorization:`Bearer ${r}`},responseType:"arraybuffer"});if(c.status>=300)return console.log("Error occurred during file download:",c),void o(!1);o(c.data)}catch(e){console.log("Error occurred during file download:",e),o(!1)}}))))}}class h{constructor(e,t){this.config=e,this.thirdpartyRequest=t}listFiles(t){return a(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken();return(yield e.post("https://api.dropboxapi.com/2/files/list_folder",{path:"/"+t},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}})).data.entries.map((e=>e.name))}catch(e){return console.log("Error listing files:",e),[]}}))}deleteFile(t){return a(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken();yield e.post("https://api.dropboxapi.com/2/files/delete_v2",{path:"/"+t},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});return!0}catch(e){return console.log("Error deleting file:",e),!1}}))}refreshToken(){return a(this,void 0,void 0,(function*(){if(this.config.access_token&&this.config.expires_at>(new Date).getTime())return this.config.access_token;let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"dropbox",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}))}authToken(e){return a(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"dropbox",redirect_uri:l.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://www.dropbox.com/oauth2/authorize?response_type=code&token_access_type=offline&client_id=${l.dropboxClientId}&redirect_uri=${l.callbackUrl}`}}class g extends h{constructor(e,t){super(e,t)}uploadFile(t,o){return new Promise(((r,i)=>a(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();let n=o.split("/").pop()||"",a=new File([t],n,{lastModified:(new Date).getTime(),type:t.type});const s=yield e.post("https://content.dropboxapi.com/2/files/upload",a,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:"/"+o,mode:"overwrite",autorename:!0,mute:!1})},maxContentLength:1/0,maxBodyLength:1/0});if(s.status>=300)return console.log("Error occurred during file download:",s),void r(!1);r(!0)}catch(e){console.log("Error uploading file:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>a(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),i=yield e({url:"https://content.dropboxapi.com/2/files/download",method:"post",headers:{Authorization:`Bearer ${r}`,"Dropbox-API-Arg":JSON.stringify({path:"/"+t})},maxContentLength:1/0,maxBodyLength:1/0,responseType:"arraybuffer"});if(i.status>=300)return console.log("Error occurred during file download:",i),void o(!1);o(i.data)}catch(e){console.log("Error occurred during file download:",e),o(!1)}}))))}}class y{constructor(e,t){this.config=e,this.thirdpartyRequest=t}getFileId(t,o){return a(this,void 0,void 0,(function*(){const r=yield this.refreshToken(),i=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+'${o}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=yield e.get(i,{headers:{Authorization:"Bearer "+r}});if(0===t.data.files.length)return"";const o=t.data.files;return o.length>0?o[0].id:null}catch(e){return console.log("Error occurred during file list retrieval:",e),""}}))}checkFolder(t){return a(this,void 0,void 0,(function*(){const o=yield this.refreshToken(),r=yield this.getFolderId(t);if(r)return r;const i={name:t,mimeType:"application/vnd.google-apps.folder",parents:["appDataFolder"]};try{return(yield e.post("https://www.googleapis.com/drive/v3/files",i,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}})).data.id}catch(e){throw console.log("Error occurred during folder creation:",e),e}}))}getFolderId(t){return a(this,void 0,void 0,(function*(){const o=yield this.refreshToken(),r=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+mimeType='application/vnd.google-apps.folder'+and+'appDataFolder'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=(yield e.get(r,{headers:{Authorization:`Bearer ${o}`}})).data.files;return t.length>0?t[0].id:null}catch(e){throw console.log("Error occurred during fetching folder ID:",e),e}}))}listFiles(t){return a(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken();const r=`https://www.googleapis.com/drive/v3/files?q='${yield this.checkFolder(t)}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;return(yield e.get(r,{headers:{Authorization:`Bearer ${o}`}})).data.files.map((e=>e.name))}catch(e){return console.log("Error listing files:",e),[]}}))}deleteFile(t){return a(this,void 0,void 0,(function*(){const o=t.split("/")[1],r=t.split("/")[0],i=yield this.getFolderId(r),n=yield this.refreshToken(),a=yield this.getFileId(o,i);if(""===a)return console.log("File not found:",o),!1;try{const t=yield e.delete(`https://www.googleapis.com/drive/v3/files/${a}`,{headers:{Authorization:`Bearer ${n}`}});return console.log("File deleted:",t),!0}catch(e){return console.log("Error deleting file:",e),!1}}))}refreshToken(){return a(this,void 0,void 0,(function*(){if(this.config.access_token&&this.config.expires_at>(new Date).getTime())return this.config.access_token;let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"google",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}))}authToken(e){return a(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"google",redirect_uri:l.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${l.callbackUrl}&prompt=consent&response_type=code&client_id=${l.googleClientId}&scope=https://www.googleapis.com/auth/drive.appdata&access_type=offline`}}const m=e=>"json"===e?"application/json":["jpg","jpeg","png","gif","bmp"].includes(e)?"image/"+e:"zip"===e?"application/zip":"epub"===e?"application/epub+zip":"txt"===e?"text/plain":"pdf"===e?"application/pdf":"mobi"===e?"application/x-mobipocket-ebook":"azw3"===e||"azw"===e?"application/vnd.amazon.ebook":"cbz"===e?"application/x-cbz":"cbr"===e?"application/x-cbr":"cbt"===e?"application/x-cbt":"cb7"===e?"application/x-cb7":"fb2"===e?"application/x-fictionbook+xml":"html"===e?"text/html":"css"===e?"text/css":"js"===e?"application/javascript":"xml"===e?"application/xml":"xhtml"===e?"application/xhtml+xml":"opf"===e?"application/oebps-package+xml":"ncx"===e?"application/x-dtbncx+xml":"mp3"===e?"audio/mpeg":"wav"===e?"audio/wav":"ogg"===e?"audio/ogg":"mp4"===e?"video/mp4":"webm"===e?"video/webm":"avi"===e?"video/x-msvideo":"wmv"===e?"video/x-ms-wmv":"flv"===e?"video/x-flv":"m3u8"===e?"application/x-mpegURL":"ts"===e?"video/MP2T":"3gp"===e?"video/3gpp":"3g2"===e?"video/3gpp2":"db"===e?"application/x-sqlite3":void 0,v=["books","notes","bookmarks","plugins","words"],k=e=>{var t=new ArrayBuffer(e.byteLength);return new Uint8Array(t).set(new Uint8Array(e)),t},b=e=>{const t=atob(e),o=t.length,r=new Uint8Array(o);for(let e=0;e<o;e++)r[e]=t.charCodeAt(e);return r.buffer},w=e=>{let t="";const o=new Uint8Array(e),r=o.byteLength;for(let e=0;e<r;e++)t+=String.fromCharCode(o[e]);return btoa(t)};var E={getMimeType:m,databaseList:v,configList:["themeColors","readingTime","cloudSyncTime","recentBooks","recentAdd","deletedBooks","favoriteBooks","shelfList","noteTags","recordLocation","sortedShelfList"],copyArrayBuffer:k,base64ToArrayBuffer:b,arrayBufferToBase64:w,generateSHA256Hash:function(e){return a(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e),o=yield crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(o)).map((e=>e.toString(16).padStart(2,"0"))).join("")}))}};class C extends y{constructor(e,t){super(e,t),this.getData=e=>new Promise(((t,o)=>{if(e){const r=new FileReader;r.onload=o=>t({fileName:e.name,mimeType:e.type,fileSize:e.size,data:o.target.result}),r.onerror=e=>o(e),r.readAsArrayBuffer(e)}else t({})}))}uploadFile(t,o){return new Promise(((r,i)=>a(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();let n=o.split("/").pop()||"",a=new File([t],n,{lastModified:(new Date).getTime(),type:t.type}),s=o.split(".").pop(),l=m(s||""),c=o.split("/")[0],d=yield this.checkFolder(c),u=yield this.getFileId(n||"",d);const p={mimeType:l,name:n,parents:[d]},f=u?`https://www.googleapis.com/upload/drive/v3/files/${u}?uploadType=resumable`:"https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable",h=(yield e({method:u?"PATCH":"POST",url:f,data:u?null:JSON.stringify(p),headers:{Authorization:"Bearer "+i,"Content-Type":"application/json; charset=UTF-8"},maxContentLength:1/0,maxBodyLength:1/0})).headers.location,g=yield this.getData(a);if(0===Object.keys(g).length)return;const y=yield e.put(h,g.data,{headers:{Authorization:"Bearer "+i,"Content-Type":"application/zip","Content-Range":`bytes 0-${g.fileSize-1}/${g.fileSize}`},maxContentLength:1/0,maxBodyLength:1/0});if(y.status>=300)return console.log("Error occurred during file download:",y),void r(!1);r(!0)}catch(e){console.log("Error uploading file:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>a(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();let n=t.split("/").pop(),a=t.split("/")[0],s=yield this.checkFolder(a),l=yield this.getFileId(n||"",s);l||r(new Error("File not found"));const c=`https://www.googleapis.com/drive/v3/files/${l}?alt=media`,d=yield e.get(c,{headers:{Authorization:"Bearer "+i},maxContentLength:1/0,maxBodyLength:1/0,responseType:"arraybuffer"});if(d.status>=300)return console.log("Error occurred during file download:",d),void o(!1);o(d.data)}catch(e){console.log("Error occurred during file download:",e),o(!1)}}))))}}class T{constructor(e){this.folderCreationLocks=new Map,this.config=e}getStorage(){return a(this,void 0,void 0,(function*(){if(this.storage)return this.storage;let{email:e,password:o}=this.config;return this.storage=yield new t({email:e,password:o}).ready,this.storage}))}createFolder(e,t){return a(this,void 0,void 0,(function*(){const o=`${e.nodeId}_${t}`;if(this.folderCreationLocks.has(o))return yield this.folderCreationLocks.get(o);const r=(()=>a(this,void 0,void 0,(function*(){try{let o=e.children.find((e=>e.name===t&&e.directory));return console.log("folder",o),o?o:(o=yield e.mkdir(t),o)}finally{this.folderCreationLocks.delete(o)}})))();return this.folderCreationLocks.set(o,r),yield r}))}listFiles(e){return a(this,void 0,void 0,(function*(){try{const t=yield this.getStorage();let o=t.root.navigate(this.config.path);if(e){const t=e.split("/").filter((e=>e));for(const e of t){const t=o.children.find((t=>t.name===e&&t.directory));if(!t)return[];o=t}}return o.children.filter((e=>!e.directory)).map((e=>e.name))}catch(e){return console.log("Error listing MEGA files:",e),[]}}))}deleteFile(e){return a(this,void 0,void 0,(function*(){try{const t=yield this.getStorage();let o=t.root.navigate(this.config.path);const r=e.split("/"),i=r.pop();for(const e of r){if(!e)continue;const t=o.children.find((t=>t.name===e&&t.directory));if(!t)return!1;o=t}const n=o.children.find((e=>e.name===i&&!e.directory));return!!n&&(yield n.delete(),!0)}catch(e){return console.log("Error deleting MEGA file:",e),!1}}))}}class x extends T{constructor(e){super(e)}uploadFile(e,t){return new Promise(((r,i)=>a(this,void 0,void 0,(function*(){try{const i=yield this.getStorage();let n=i.root.navigate(this.config.path);const a=t.split("/"),s=a.pop()||"";for(const e of a){if(!e)continue;let t=n.children.find((t=>t.name===e&&t.directory));console.log("folder",t),t||(t=yield this.createFolder(n,e)),n=t}const l=new File([e],s,{lastModified:(new Date).getTime(),type:e.type}),c=yield e.arrayBuffer(),d=new Uint8Array(c),u=o.from(d);console.log("buffer",u);const p=n.children.find((e=>e.name===s&&!e.directory));p&&(yield p.delete()),yield n.upload({name:s,size:l.size},u).complete,r(!0)}catch(e){console.log("Error occurred during MEGA file upload:",e),r(!1)}}))))}downloadFile(e){return new Promise(((t,o)=>a(this,void 0,void 0,(function*(){try{const o=yield this.getStorage();let r=o.root.navigate(this.config.path);const i=e.split("/"),n=i.pop()||"";console.log("pathParts",i);for(const e of i){if(!e)continue;const o=r.children.find((t=>t.name===e&&t.directory));if(!o)return void t(!1);r=o}const a=r.children.find((e=>e.name===n&&!e.directory));if(console.log("file",a),!a)return void t(!1);const s=yield a.downloadBuffer();console.log("arrayBuffer",s),t(s)}catch(e){console.log("Error occurred during MEGA file download:",e),t(!1)}}))))}}class _{constructor(e,t){this.config=e,this.thirdpartyRequest=t}listFiles(t){return a(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),r=yield e.get(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/children`,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});return r.status>=300?[]:r.data.value.map((e=>e.name))}catch(e){return console.log("Error occurred during file list:",e),[]}}))}deleteFile(t){return a(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),r=yield e.delete(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}`,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});return!(r.status>=300)||(console.log("Error deleting file:",r),!1)}catch(e){return console.log("Error occurred during file delete:",e),!1}}))}refreshToken(){return a(this,void 0,void 0,(function*(){if(this.config.access_token&&this.config.expires_at>(new Date).getTime())return this.config.access_token;let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"microsoft",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}))}authToken(e){return a(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"microsoft",redirect_uri:l.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${l.microsoftClientId}&scope=files.readwrite.appfolder offline_access&response_type=code&redirect_uri=${l.callbackUrl}`}}class S extends _{constructor(e,t){super(e,t)}uploadFile(t,o){return new Promise(((r,i)=>a(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();let n=o.split("/").pop()||"",a=new File([t],n,{lastModified:(new Date).getTime(),type:t.type});const s="https://graph.microsoft.com/v1.0/me/drive/special/approot:/"+o+":/createUploadSession",l=yield e.post(s,null,{headers:{Authorization:"Bearer "+i,"Content-Type":"application/json"},maxContentLength:1/0,maxBodyLength:1/0});let c=a.size;const d=a.type,u=l.data.uploadUrl,p=yield e.put(u,a,{headers:{"Content-Type":d,"Content-Range":`bytes 0-${c-1}/${c}`},maxContentLength:1/0,maxBodyLength:1/0});if(p.status>=300)return console.log("Error occurred during file download:",p),void r(!1);r(!0)}catch(e){console.log("Error uploading file:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>a(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),i=`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/content`,n=yield e.get(i,{responseType:"arraybuffer",headers:{Authorization:"Bearer "+r},maxContentLength:1/0,maxBodyLength:1/0});if(n.status>=300)return console.log("Error occurred during file download:",n),void o(!1);o(n.data)}catch(e){console.log("Error occurred during file download:",e),o(!1)}}))))}}class R{downloadFile(e,t){return a(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}uploadFile(e,t){return a(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}listFiles(e){return a(this,void 0,void 0,(function*(){return new Promise((e=>{e([])}))}))}authToken(e){return a(this,void 0,void 0,(function*(){return new Promise((e=>{e("")}))}))}getAuthUrl(){return""}}class A{constructor(e,t){this.config=e,this.thirdpartyRequest=t}checkFolderExists(t,o){return a(this,void 0,void 0,(function*(){console.log("checkFolderExists",t);try{const r=yield e.get("https://api.pcloud.com/listfolder",{params:{access_token:o,path:`/${t}`}});return console.log("checkFolderExists response",r.data),0===r.data.result}catch(e){return console.log("Error checking folder:",e),!1}}))}createFolder(t,o){return a(this,void 0,void 0,(function*(){console.log("createFolder",t);try{const r=yield e.get("https://api.pcloud.com/createfolderifnotexists",{params:{access_token:o,path:`/${t}`}});return console.log("createFolder response",r.data),0===r.data.result}catch(e){return console.log("Error creating folder:",e),!1}}))}listFiles(t){return a(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),r=yield e.get("https://api.pcloud.com/listfolder",{params:{access_token:o,path:"/"+t,recursive:0}});return 0!==r.data.result?[]:(console.log("listFiles response",r.data),r.data.metadata.contents.map((e=>e.name)))}catch(e){return console.log("Error occurred during file list:",e),[]}}))}deleteFile(t){return a(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),r=yield e.get("https://api.pcloud.com/deletefile",{params:{access_token:o,path:"/"+t}});return 0===r.data.result||(console.log("Error deleting file:",r.data),!1)}catch(e){return console.log("Error occurred during file delete:",e),!1}}))}refreshToken(){return a(this,void 0,void 0,(function*(){return this.config.refresh_token}))}authToken(e){return a(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"pcloud",redirect_uri:l.callbackUrl,code:e})).data.access_token}))}getAuthUrl(){return`https://my.pcloud.com/oauth2/authorize?client_id=${l.pcloudClientId}&response_type=code&redirect_uri=${l.callbackUrl}`}}class O extends A{constructor(e,t){super(e,t)}uploadFile(t,o){return new Promise(((r,i)=>a(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),n=o.split("/").slice(0,-1).join("/");if(!(yield this.checkFolderExists(n,i))){const e=yield this.createFolder(n,i);if(console.log("Folder created:",e),!e)return void r(!1)}let a=o.split("/").pop()||"",s=new File([t],a,{lastModified:(new Date).getTime(),type:t.type});const l=new FormData;l.append("file",s),console.log("uploadFile",o);const c=yield e.post("https://api.pcloud.com/uploadfile",l,{params:{access_token:i,path:`/${n}`,renew:1},maxContentLength:1/0,maxBodyLength:1/0});if(0!==c.data.result)return console.log("Error uploading file:",c.data),void r(!1);r(!0)}catch(e){console.log("Error uploading file:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>a(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),i=yield e.get("https://api.pcloud.com/getfilelink",{params:{access_token:r,path:`/${t}`}});if(0!==i.data.result)return console.log("Error getting file link:",i.data),void o(!1);const n=`https://${i.data.hosts[0]}${i.data.path}`,a=yield e.get(n,{responseType:"arraybuffer",maxContentLength:1/0,maxBodyLength:1/0});if(a.status>=300)return console.log("Error downloading file:",a),void o(!1);o(a.data)}catch(e){console.log("Error occurred during file download:",e),o(!1)}}))))}}class I{constructor(e,t){this.config=e,this.thirdpartyRequest=t}listFiles(e){return a(this,void 0,void 0,(function*(){let{endpoint:t,region:o,bucketName:r,accessKeyId:i,secretAccessKey:n,dir:a}=this.config;try{return(yield this.thirdpartyRequest.s3List({bucket_name:r,prefix:a+"/"+e,region:o,endpoint:t,access_key_id:i,secret_access_key:n})).data.contents.map((e=>e.split("/").pop()))}catch(e){return console.log("Error listing files:",e),[]}}))}deleteFile(e){return a(this,void 0,void 0,(function*(){let{endpoint:t,region:o,bucketName:r,accessKeyId:i,secretAccessKey:n,dir:a}=this.config;try{yield this.thirdpartyRequest.s3Delete({bucket_name:r,object_key:a+"/"+e,region:o,endpoint:t,access_key_id:i,secret_access_key:n});return!0}catch(e){return console.log("Error deleting file:",e),!1}}))}}class F extends I{constructor(e,t){super(e,t)}uploadFile(t,o){return new Promise(((r,i)=>a(this,void 0,void 0,(function*(){let{endpoint:i,region:n,bucketName:a,accessKeyId:s,secretAccessKey:l,dir:c}=this.config;try{const d=(yield this.thirdpartyRequest.s3Upload({bucket_name:a,object_key:c+"/"+o,region:n,endpoint:i,access_key_id:s,secret_access_key:l})).data.url;let u=o.split("/").pop()||"",p=new File([t],u,{lastModified:(new Date).getTime(),type:t.type});yield e.put(d,p,{headers:{},maxContentLength:1/0,maxBodyLength:1/0});r(!0)}catch(e){console.log("Error occurred during file upload:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>a(this,void 0,void 0,(function*(){let{endpoint:r,region:i,bucketName:n,accessKeyId:a,secretAccessKey:s,dir:l}=this.config;try{const c=(yield this.thirdpartyRequest.s3Download({bucket_name:n,object_key:l+"/"+t,region:i,endpoint:r,access_key_id:a,secret_access_key:s})).data.url,d=yield e({url:c,method:"get",headers:{},responseType:"arraybuffer",maxContentLength:1/0,maxBodyLength:1/0});o(d.data)}catch(e){console.log("Error occurred during file download:",e),o(!1)}}))))}}class L{constructor(e){let{username:t,password:o,url:n,dir:a}=e;this.client=r(n,{authType:i.Password,username:t,password:o}),this.username=t,this.password=o,this.dir=a}uploadFile(t,o){return new Promise(((r,i)=>a(this,void 0,void 0,(function*(){try{!1===(yield this.client.exists(o.substring(0,o.lastIndexOf("/"))))&&(yield this.client.createDirectory(o.substring(0,o.lastIndexOf("/"))));let i=o.split("/").pop()||"",n=new File([t],i,{lastModified:(new Date).getTime(),type:t.type}),a=this.client.getFileUploadLink(this.dir+"/"+o);const s=new URL(a);s.search="",a=s.toString();const l=btoa(this.username+":"+this.password);yield e.put(a,n,{headers:{Authorization:"Basic "+l},maxContentLength:1/0,maxBodyLength:1/0});r(!0)}catch(e){console.log("Error uploading file:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>a(this,void 0,void 0,(function*(){try{const r=this.client.getFileDownloadLink(this.dir+"/"+t),i=btoa(this.username+":"+this.password),n=yield e({url:r,method:"get",headers:{Authorization:"Basic "+i},responseType:"arraybuffer",maxContentLength:1/0,maxBodyLength:1/0});if(n.status>=300)return console.log("Error occurred during file download:",n),void o(!1);o(n.data)}catch(e){console.log("Error occurred during file download:",e),o(!1)}}))))}listFiles(e){return a(this,void 0,void 0,(function*(){try{return(yield this.client.getDirectoryContents(this.dir+"/"+e)).map((e=>e.basename))}catch(e){return console.log("Error listing files:",e),[]}}))}deleteFile(e){return a(this,void 0,void 0,(function*(){try{return yield this.client.deleteFile(this.dir+"/"+e),!0}catch(e){return console.log("Error deleting file:",e),!1}}))}}const j=["book","config","cover","font"];class B{constructor(e,t,o){this.type=e,this.remote="dropbox"===e?new g(t,o):"microsoft"===e?new S(t,o):"google"===e?new C(t,o):"s3compatible"===e?new F(t,o):"webdav"===e?new L(t):"boxnet"===e?new f(t,o):"mega"===e?new x(t):"adrive"===e?new u(t,o):"pcloud"===e?new O(t,o):new R}downloadFile(e,t){return a(this,void 0,void 0,(function*(){return!!(yield this.listFiles(t)).find((t=>e.indexOf(t)>-1))&&(yield this.remote.downloadFile(t+"/"+e))}))}uploadFile(e,t,o){return a(this,void 0,void 0,(function*(){return yield this.remote.uploadFile(o,t+"/"+e)}))}deleteFile(e,t){return a(this,void 0,void 0,(function*(){return yield this.remote.deleteFile(t+"/"+e)}))}listFiles(e){return a(this,void 0,void 0,(function*(){return yield this.remote.listFiles(e)}))}isExist(e,t){return a(this,void 0,void 0,(function*(){return(yield this.listFiles(t)).find((t=>-1!==t.indexOf(e)))}))}downloadAllFiles(){return a(this,void 0,void 0,(function*(){for(let e of j){let t=yield this.listFiles(e);for(let o of t)yield this.downloadFile(o,e)}}))}authToken(e){return a(this,void 0,void 0,(function*(){return yield this.remote.authToken(e)}))}getAuthUrl(){return this.remote.getAuthUrl?this.remote.getAuthUrl():""}}const M={notes:"SELECT * FROM notes WHERE key = ?",bookmarks:"SELECT * FROM bookmarks WHERE key = ?",books:"SELECT * FROM books WHERE key = ?",plugins:"SELECT * FROM plugins WHERE key = ?",words:"SELECT * FROM words WHERE key = ?"},z={notes:"SELECT * FROM notes WHERE bookKey = ?",bookmarks:"SELECT * FROM bookmarks WHERE bookKey = ?",words:"SELECT * FROM words WHERE bookKey = ?",books:"SELECT * FROM books WHERE key = ?"},D={notes:"DELETE FROM notes WHERE bookKey = ?",bookmarks:"DELETE FROM bookmarks WHERE bookKey = ?",words:"DELETE FROM words WHERE bookKey = ?"};function U(e){for(const t in e)e.hasOwnProperty(t)&&(e[`temp-${t}`]=e[t]);return e}const N={notes:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t.tag=JSON.parse(e.tag),t},bookmarks:e=>e,books:e=>e,plugins:e=>{let t=Object.assign({},e);return e.autoValue||delete t.autoValue,e.langList?t.langList=JSON.parse(e.langList):delete t.langList,e.voiceList?t.voiceList=JSON.parse(e.voiceList):delete t.voiceList,t.config=JSON.parse(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t}};var $,P={sqlStatement:{createTableStatement:U({notes:'\n      CREATE TABLE IF NOT EXISTS "notes" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "chapter" text,\n        "chapterIndex" integer,\n        "text" text,\n        "cfi" text,\n        "range" text,\n        "notes" text,\n        "percentage" text,\n        "color" integer,\n        "tag" array\n      )\n    ',bookmarks:'\n      CREATE TABLE IF NOT EXISTS "bookmarks" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "cfi" text,\n        "label" text,\n        "percentage" text,\n        "chapter" text\n      );\n    ',books:'\n      CREATE TABLE IF NOT EXISTS "books" (\n        "key" text PRIMARY KEY,\n        "name" text,\n        "author" text,\n        "description" text,\n        "md5" text,\n        "cover" text,\n        "format" text,\n        "publisher" text,\n        "size" integer,\n        "page" integer,\n        "path" text,\n        "charset" text\n      );\n    ',plugins:'\n      CREATE TABLE IF NOT EXISTS "plugins" (\n        "key" text PRIMARY KEY,\n        "type" text,\n        "displayName" text,\n        "icon" text,\n        "version" text,\n        "config" object,\n        "autoValue" string,\n        "langList" text,\n        "voiceList" text,\n        "scriptSHA256" text,\n        "script" text\n      );\n    ',words:'\n      CREATE TABLE IF NOT EXISTS "words" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "word" text,\n        "chapter" text\n      );\n    '}),getAllStatement:U({notes:"SELECT * FROM notes",bookmarks:"SELECT * FROM bookmarks",books:"SELECT * FROM books",plugins:"SELECT * FROM plugins",words:"SELECT * FROM words"}),saveStatement:U({notes:"INSERT OR REPLACE INTO notes (key, bookKey, chapter, chapterIndex, text, cfi, range, notes, date, percentage, color, tag) VALUES (@key, @bookKey, @chapter, @chapterIndex, @text, @cfi, @range, @notes, @date, @percentage, @color, @tag)",bookmarks:"INSERT OR REPLACE INTO bookmarks (key, bookKey, cfi, label, percentage, chapter) VALUES (@key, @bookKey, @cfi, @label, @percentage, @chapter)",books:"INSERT OR REPLACE INTO books (key, name, author, description, md5, cover, format, publisher, size, page, path, charset) VALUES (@key, @name, @author, @description, @md5, @cover, @format, @publisher, @size, @page, @path, @charset)",plugins:"INSERT OR REPLACE INTO plugins (key, type, displayName, icon, version, config, autoValue, langList, voiceList, scriptSHA256, script) VALUES (@key, @type, @displayName, @icon, @version, @config, @autoValue, @langList, @voiceList, @scriptSHA256, @script)",words:"INSERT OR REPLACE INTO words (key, bookKey, date, word, chapter) VALUES (@key, @bookKey, @date, @word, @chapter)"}),deleteAllStatement:U({notes:"DELETE FROM notes",bookmarks:"DELETE FROM bookmarks",books:"DELETE FROM books",plugins:"DELETE FROM plugins",words:"DELETE FROM words"}),updateStatement:U({notes:"UPDATE notes SET bookKey = @bookKey, chapter = @chapter, chapterIndex = @chapterIndex, text = @text, cfi = @cfi, range = @range, notes = @notes, date = @date, percentage = @percentage, color = @color, tag = @tag WHERE key = @key",bookmarks:"UPDATE bookmarks SET bookKey = @bookKey, cfi = @cfi, label = @label, percentage = @percentage, chapter = @chapter WHERE key = @key",books:"UPDATE books SET name = @name, author = @author, description = @description, md5 = @md5, cover = @cover, format = @format, publisher = @publisher, size = @size, page = @page, path = @path, charset = @charset WHERE key = @key",plugins:"UPDATE plugins SET type = @type, displayName = @displayName, icon = @icon, version = @version, config = @config, autoValue = @autoValue, langList = @langList, voiceList = @voiceList, scriptSHA256 = @scriptSHA256, script = @script WHERE key = @key",words:"UPDATE words SET bookKey = @bookKey, date = @date, word = @word, chapter = @chapter WHERE key = @key"}),deleteStatement:U({notes:"DELETE FROM notes WHERE key = ?",bookmarks:"DELETE FROM bookmarks WHERE key = ?",books:"DELETE FROM books WHERE key = ?",plugins:"DELETE FROM plugins WHERE key = ?",words:"DELETE FROM words WHERE key = ?"}),dropStatement:U({notes:"DROP TABLE IF EXISTS notes",bookmarks:"DROP TABLE IF EXISTS bookmarks",books:"DROP TABLE IF EXISTS books",plugins:"DROP TABLE IF EXISTS plugins",words:"DROP TABLE IF EXISTS words"}),getStatement:U(M),getByBookKeyStatement:U(z),getByBookKeysStatement:U({notes:e=>`SELECT * FROM notes WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,bookmarks:e=>`SELECT * FROM bookmarks WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,words:e=>`SELECT * FROM words WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,books:e=>`SELECT * FROM books WHERE key IN (${e.map((()=>"?")).join(",")})`}),deleteByBookKeyStatement:U(D)},jsonToSqlite:U({notes:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t.tag=JSON.stringify(e.tag),t},bookmarks:e=>e,books:e=>{let t=Object.assign({},e);return t.page=e.page||0,t},plugins:e=>{let t=Object.assign({},e);return e.autoValue||(t.autoValue=null),e.langList?t.langList=JSON.stringify(e.langList):t.langList=null,e.voiceList?t.voiceList=JSON.stringify(e.voiceList):t.voiceList=null,t.config=JSON.stringify(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t}}),sqliteToJson:U(N)};class q{constructor(e,t,o,r,i,n,a,s,l,c,d,u){this.key=e,this.name=t,this.author=o,this.description=r,this.md5=i,this.cover=n,this.format=a,this.publisher=s,this.size=l,this.page=c,this.path=d,this.charset=u}}class W{static generateBook(e,t,o,r,i,n,s){return new Promise(((l,c)=>a(this,void 0,void 0,(function*(){try{let a,c,d,u,p,f,h,g,y="";switch([c,d,p,u,f,h]=[e,"","","","",0],t){case"pdf":case"epub":case"mobi":case"azw":case"azw3":case"fb2":g=yield s.getMetadata(),[c,d,p,u,y]=[g.name||e,g.author||"",g.description||"",g.publisher||"",g.cover||""];break;case"cbr":case"cbt":case"cbz":case"cb7":g=yield s.getMetadata(),y=g.cover;break;case"txt":g=yield s.getMetadata(n),f=g.charset}let m=t.toUpperCase();a=(new Date).getTime()+"",l(new q(a,c,d,p,o,y,m,u,r,h,i,f))}catch(e){console.log(e),c(e)}}))))}}$=W,W.getRendtion=(e,t,o,r,i,n,a,s)=>{let l;return"CACHE"===t?l=new s.CacheRender(e,{readerMode:o,animation:i,isBionic:n,convertChinese:a}):"MOBI"===t||"AZW3"===t||"AZW"===t?l=new s.MobiRender(e,{readerMode:o,animation:i,isBionic:n,convertChinese:a}):"EPUB"===t?l=new s.EpubRender(e,{readerMode:o,animation:i,isBionic:n,convertChinese:a}):"TXT"===t?l=new s.TxtRender(e,{readerMode:o,animation:i,charset:r,isBionic:n,convertChinese:a}):"MD"===t?l=new s.MdRender(e,{readerMode:o,animation:i,isBionic:n,convertChinese:a}):"PDF"===t?l=new s.PdfRender(e,{readerMode:o,animation:i,isBionic:n,convertChinese:a}):"FB2"===t?l=new s.Fb2Render(e,{readerMode:o,animation:i,isBionic:n,convertChinese:a}):"DOCX"===t?l=new s.DocxRender(e,{readerMode:o,animation:i,isBionic:n,convertChinese:a}):"HTML"===t||"XHTML"===t||"MHTML"===t||"HTM"===t||"XML"===t?l=new s.HtmlRender(e,{readerMode:o,format:t,animation:i,isBionic:n,convertChinese:a}):"CBR"!==t&&"CBT"!==t&&"CBZ"!==t&&"CB7"!==t||(l=new s.ComicRender(k(e),{readerMode:o,format:t,animation:i,isBionic:n,convertChinese:a})),l},W.addMobileBook=(e,t,o,r,i,n)=>a(void 0,void 0,void 0,(function*(){try{let a=b(e),s=$.getRendtion(a,o.toUpperCase(),"","","","no","no",window.Kookit),l=yield W.generateBook(t,o,r,i,n,a,s);if(!l||!l.key)return;window.ReactNativeWebView.postMessage(JSON.stringify({event:"metadata",bookInfo:l}));let c=yield s.preCache(a);if(""===c)window.ReactNativeWebView.postMessage(JSON.stringify({event:"cache",cacheBase64:"",key:l.key}));else if("err"!==c){let e=w(c);window.ReactNativeWebView.postMessage(JSON.stringify({event:"cache",cacheBase64:e,key:l.key}))}else window.ReactNativeWebView.postMessage(JSON.stringify({event:"error",message:"Parse book failed"}))}catch(e){console.log(e),window.ReactNativeWebView.postMessage(JSON.stringify({event:"error",message:"Parse book failed"}))}}));class K{constructor(e){this.accessToken=e}}const J=s.cloudUrl;class H{constructor(e,t){this.TokenService=e,this.ConfigService=t}refreshUserToken(){return a(this,void 0,void 0,(function*(){let t=yield this.TokenService.getToken("refresh_token"),o=(yield e.post(J+"/api/v1/public/user/refresh_token",{refresh_token:t})).data;return 200===o.code&&(yield this.TokenService.setToken("access_token",o.data.access_token),yield this.TokenService.setToken("refresh_token",o.data.refresh_token)),o}))}requestWithRetry(t){return a(this,void 0,void 0,(function*(){let o="";try{o=(yield this.TokenService.getToken("access_token"))||""}catch(e){console.log("Error get Token:",e)}let r="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);t.baseURL=J,t.headers={Authorization:"Bearer "+o,"X-Request-ID":r},console.log(t,"config");let i=(yield e(t)).data;if(402===i.code){let r=yield this.refreshUserToken();if(200===r.code){return t.headers=t.headers||{},t.headers.Authorization="Bearer "+o,(yield e(t)).data}return r}return 200!==i.code&&this.ConfigService.setItem("errorLog",JSON.stringify({request:t.data,url:t.url,result:i,requestID:r})),i}))}}class V extends H{constructor(e,t){super(e,t)}encryptToken(e){return a(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/encrypt_token",data:e};return yield this.requestWithRetry(t)}))}decryptToken(e){return a(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/decrypt_token",data:e};return yield this.requestWithRetry(t)}))}authThirdToken(e){return a(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/auth_token",data:e};return yield this.requestWithRetry(t)}))}refreshThirdToken(e){return a(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/refresh_token",data:e};return yield this.requestWithRetry(t)}))}s3Upload(e){return a(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_upload",data:e};return yield this.requestWithRetry(t)}))}s3Download(e){return a(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_download",data:e};return yield this.requestWithRetry(t)}))}s3List(e){return a(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_list",data:e};return yield this.requestWithRetry(t)}))}s3Delete(e){return a(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_delete",data:e};return yield this.requestWithRetry(t)}))}getSyncState(){return a(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"get",url:"/api/v1/pro/thirdparty/get_sync_state"})}))}deleteSyncState(){return a(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/pro/thirdparty/delete_sync_state"})}))}}class X extends H{constructor(e,t){super(e,t)}loginRegister(e){return a(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/public/user/login_register",data:e};return yield this.requestWithRetry(t)}))}logout(){return a(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/logout"})}))}getLogins(){return a(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/get_logins"})}))}addLogin(e){return a(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/member/user/add_login",data:e};return yield this.requestWithRetry(t)}))}removeLogin(e){return a(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/member/user/remove_login",data:e};return yield this.requestWithRetry(t)}))}getUserInfo(){return a(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/get_info"})}))}}var Q={getAuthUrl:(e,t)=>{let o="";if("github"===e?o=`https://github.com/login/oauth/authorize?client_id=${l.githubClientId}&redirect_uri=${l.callbackUrl}&scope=openid`:"google"===e?o=`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${l.callbackUrl}&prompt=consent&response_type=code&client_id=${l.googleClientId}&scope=openid&access_type=offline`:"facebook"===e?o=`https://www.facebook.com/v12.0/dialog/oauth?client_id=${l.facebookClientId}&redirect_uri=${l.callbackUrl}&scope=&response_type=code`:"microsoft"===e&&(o=`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${l.microsoftClientId}&scope=openid profile User.Read offline_access&response_type=code&redirect_uri=${l.callbackUrl}`),"manual"===t)return o;let r=JSON.stringify({deeplink:"desktop"===t?"koodo-reader://callback":"browser"===t?"https://web.koodoreader.com/#/login":"",service:e});return`${o}&state=${"state|"+encodeURIComponent(r)}`}};function Y(e,t,o){return a(this,void 0,void 0,(function*(){if("ftp"!==o&&"adrive"!==o){const o=[],r=[];for(const i of e){const e=i().then((t=>(r.splice(r.indexOf(e),1),t)));o.push(e),r.push(e),r.length>=t&&(yield Promise.race(r))}return Promise.all(o)}for(let t of e)yield t()}))}class G{static CompareDatabase(e,t,o){return a(this,void 0,void 0,(function*(){let r=Object.keys(e).filter((e=>e.startsWith("database.sqlite.books"))),i=Object.keys(e).filter((e=>e.startsWith("database.sqlite.notes"))),n=Object.keys(e).filter((e=>e.startsWith("database.sqlite.bookmarks"))),a=Object.keys(e).filter((e=>e.startsWith("database.sqlite.plugins"))),s=Object.keys(e).filter((e=>e.startsWith("database.sqlite.words"))),l=Object.keys(t).filter((e=>e.startsWith("database.sqlite.books"))),c=Object.keys(t).filter((e=>e.startsWith("database.sqlite.notes"))),d=Object.keys(t).filter((e=>e.startsWith("database.sqlite.bookmarks"))),u=Object.keys(t).filter((e=>e.startsWith("database.sqlite.plugins"))),p=Object.keys(t).filter((e=>e.startsWith("database.sqlite.words"))),f={books:Array.from(new Set(r.concat(l))),notes:Array.from(new Set(i.concat(c))),bookmarks:Array.from(new Set(n.concat(d))),plugins:Array.from(new Set(a.concat(u))),words:Array.from(new Set(s.concat(p)))},h={books:{save:[],update:[],delete:[],conflict:[],upload:[]},notes:{save:[],update:[],delete:[],conflict:[],upload:[]},bookmarks:{save:[],update:[],delete:[],conflict:[],upload:[]},plugins:{save:[],update:[],delete:[],conflict:[],upload:[]},words:{save:[],update:[],delete:[],conflict:[],upload:[]}},g=["books","notes","bookmarks","plugins","words"];for(let r of g)for(let i of f[r]){let n=i.split(".")[3],a=e[i],s=t[i];a?s?("save"===s.operation&&("update"===a.operation||"delete"===a.operation?h[r].upload.push(n):console.log("ignore",s)),"delete"===s.operation&&("save"===a.operation&&(h[r].delete.push(n),e[i]=s),"update"===a.operation&&(a.time<s.time?(h[r].delete.push(n),e[i]=s):a.time>s.time?(h[r].conflict.push(n),"cloud"===o?(h[r].delete.push(n),e[i]=s):h[r].upload.push(n)):console.log("ignore",s)),"delete"===a.operation&&console.log("ignore",s)),"update"===s.operation&&("save"===a.operation&&(h[r].update.push(n),e[i]=s),"update"===a.operation&&(a.time<s.time?(h[r].update.push(n),e[i]=s):a.time>s.time?h[r].upload.push(n):console.log("ignore",s)),"delete"===a.operation&&(a.time<s.time?(h[r].conflict.push(n),"cloud"===o?(h[r].save.push(n),e[i]=s):h[r].upload.push(n)):a.time>s.time?h[r].upload.push(n):console.log("ignore",s)))):h[r].upload.push(n):(h[r].save.push(n),e[i]=s)}return{compareResult:h,syncRecords:e}}))}static CompareConfig(e,t,o){return a(this,void 0,void 0,(function*(){let r=Object.keys(e).filter((e=>e.startsWith("config.readerConfig"))),i=Object.keys(e).filter((e=>e.startsWith("config.listConfig"))),n=Object.keys(e).filter((e=>e.startsWith("config.objectConfig"))),a=Object.keys(e).filter((e=>e.startsWith("config.mapConfig"))),s=Object.keys(t).filter((e=>e.startsWith("config.readerConfig"))),l=Object.keys(t).filter((e=>e.startsWith("config.listConfig"))),c=Object.keys(t).filter((e=>e.startsWith("config.objectConfig"))),d=Object.keys(t).filter((e=>e.startsWith("config.mapConfig"))),u={readerConfig:Array.from(new Set(r.concat(s))),listConfig:Array.from(new Set(i.concat(l))),objectConfig:Array.from(new Set(n.concat(c))),mapConfig:Array.from(new Set(a.concat(d)))},p={readerConfig:{update:[],upload:[]},listConfig:{update:[],upload:[]},objectConfig:{update:[],delete:[],conflict:[],upload:[]},mapConfig:{update:[],delete:[],conflict:[],upload:[]}},f=["readerConfig","listConfig"];for(let o of f)for(let r of u[o]){let i=r,n=e[r],a=t[r];n?a?n.time<a.time?(p[o].update.push(i),e[r]=a):n.time>a.time?p[o].upload.push(i):console.log("ignore",a):p[o].upload.push(i):(p[o].update.push(i),e[r]=a)}let h=["objectConfig","mapConfig"];for(let r of h)for(let i of u[r]){let n=i,a=e[i],s=t[i];a?s?("delete"===s.operation&&("update"===a.operation&&(a.time<s.time?(p[r].delete.push(n),e[i]=s):a.time>s.time?(p[r].conflict.push(n),"cloud"===o?(p[r].delete.push(n),e[i]=s):p[r].upload.push(n)):console.log("ignore",s)),"delete"===a.operation&&console.log("ignore",s)),"update"===s.operation&&("update"===a.operation&&(a.time<s.time?(p[r].update.push(n),e[i]=s):a.time>s.time?p[r].upload.push(n):console.log("ignore",s)),"delete"===a.operation&&(a.time<s.time?(p[r].conflict.push(n),"cloud"===o?(p[r].save.push(n),e[i]=s):p[r].upload.push(n)):a.time>s.time?p[r].upload.push(n):console.log("ignore",s)))):p[r].upload.push(n):(p[r].update.push(n),e[i]=s)}return{compareResult:p,syncRecords:e}}))}static compareAll(e,t,o,r,i){return a(this,void 0,void 0,(function*(){let n="cloud";if("yes"===o.getReaderConfig("isKeepLocal")){n="local";let e=o.getObjectConfig(yield r.getFingerprint(),"cloudSyncTime",{time:0,conflictMode:"cloud"}),t=yield i.getCloudConfig("config"),a=JSON.parse(t.cloudSyncTime||"{}");delete a[yield r.getFingerprint()],Object.values(a).filter((t=>"local"===t.conflictMode&&t.time>e.time)).length>0&&(n="cloud")}let{compareResult:a,syncRecords:s}=yield this.CompareDatabase(e,t,n),{compareResult:l,syncRecords:c}=yield this.CompareConfig(s,t,n),d=Object.assign(Object.assign({},a),l);return o.setAllSyncRecord(c),"local"===n&&(d.books.conflict.length>0||d.notes.conflict.length>0||d.bookmarks.conflict.length>0||d.plugins.conflict.length>0||d.words.conflict.length>0||d.objectConfig.conflict.length>0||d.mapConfig.conflict.length>0)?o.setObjectConfig(yield r.getFingerprint(),{time:(new Date).getTime(),conflictMode:"local"},"cloudSyncTime"):o.setObjectConfig(yield r.getFingerprint(),{time:(new Date).getTime(),conflictMode:"cloud"},"cloudSyncTime"),d}))}static startSync(e,t,o,r,i,n){return a(this,void 0,void 0,(function*(){yield this.syncConfig(e,t,o,i,r),yield this.syncCover(t,n,i),yield this.syncBook(t,i)}))}static syncConfig(e,t,o,r,i){return a(this,void 0,void 0,(function*(){for(let t of v){if(e[t].save.length+e[t].update.length>0){let r=yield i.getCloudDatabase(t);for(let i of e[t].save){let e=r.find((e=>e.key===i));e&&(yield o.saveRecord(e,t))}for(let i of e[t].update){let e=r.find((e=>e.key===i));e&&(yield o.updateRecord(e,t,!1))}}if(e[t].delete.length>0)for(let i of e[t].delete)yield o.deleteRecord(i,t),"books"===t&&(yield r.deleteOfflineBook(i))}if(e.readerConfig.update.length>0||e.listConfig.update.length>0||e.objectConfig.update.length>0||e.mapConfig.update.length>0){let o=yield i.getCloudConfig("config");for(let r of e.readerConfig.update){let e=r.split(".")[3];o.readerConfig&&t.setReaderConfig(e,JSON.parse(o.readerConfig)[e],!1)}for(let r of e.listConfig.update){let e=r.split(".")[3];o[e]&&t.setAllListConfig(JSON.parse(o[e]),e,!1)}for(let r of e.objectConfig.update){let e=r.split(".")[3],i=r.split(".")[2];o[i]&&JSON.parse(o[i])&&JSON.parse(o[i])[e]&&t.setObjectConfig(e,JSON.parse(o[i])[e],i,!1)}for(let r of e.mapConfig.update){let e=r.split(".")[3],i=r.split(".")[2];if(o[i]&&JSON.parse(o[i])&&JSON.parse(o[i])[e]){let r=JSON.parse(o[i])[e];t.setOneMapConfig(e,r,i,!1)}}}if(e.objectConfig.delete.length>0||e.mapConfig.delete.length>0){for(let o of e.objectConfig.delete){let e=o.split(".")[3],r=o.split(".")[2];t.deleteObjectConfig(e,r)}for(let o of e.mapConfig.delete){let e=o.split(".")[3],r=o.split(".")[2];t.deleteMapConfig(e,r)}}for(let t of v)e[t].upload.length>0&&(yield i.uploadDatabase(t));yield i.uploadConfig("config"),yield i.uploadConfig("sync")}))}static syncCover(e,t,o){return a(this,void 0,void 0,(function*(){let o=yield t.getLocalCoverList(),r=yield t.getCloudCoverList(),i=Array.from(new Set([...o,...r])),n=[];for(let a of i)o.includes(a)&&!r.includes(a)&&n.push((()=>t.uploadCover(a))),!o.includes(a)&&r.includes(a)&&"adrive"!==e.getItem("defaultSyncOption")&&n.push((()=>t.downloadCover(a)));yield Y(n,5,e.getItem("defaultSyncOption"))}))}static syncBook(e,t){return a(this,void 0,void 0,(function*(){let o=yield t.getLocalBookList(),r=yield t.getCloudBookList(),i=[],n=Array.from(new Set([...o,...r]));for(let a of n){if(o.includes(a)&&!r.includes(a)){let e=a.split(".")[0],o=a.split(".")[1];i.push((()=>t.uploadBook(e,o)))}let n="yes"===e.getReaderConfig("autoOffline");if(!o.includes(a)&&r.includes(a)&&n&&"adrive"!==e.getItem("defaultSyncOption")){let e=a.split(".")[0],o=a.split(".")[1];"pdf"===o&&i.push((()=>t.offlineBook(e,o.toUpperCase()))),"zip"===o&&i.push((()=>t.offlineBook(e.split("-")[1],o.toUpperCase())))}}yield Y(i,5,e.getItem("defaultSyncOption"))}))}}const Z=(ee=class{static getItem(e){return localStorage.getItem(e)}static setItem(e,t){localStorage.setItem(e,t)}static removeItem(e){localStorage.removeItem(e)}},te="browser",class extends ee{static getReaderConfig(e){return JSON.parse(this.getItem("readerConfig")||"{}")[e]}static setReaderConfig(e,t,o=!0){let r=JSON.parse(this.getItem("readerConfig")||"{}");r[e]=t,this.setItem("readerConfig",JSON.stringify(r)),o&&this.setSyncRecord({type:"config",catergory:"readerConfig",name:te,key:e},{operation:"update",time:Date.now()})}static getAllListConfig(e){return("{}"!==this.getItem(e)&&this.getItem(e)?JSON.parse(this.getItem(e)||""):[])||[]}static deleteListConfig(e,t){let o=this.getAllListConfig(t);const r=o.indexOf(e);r>-1&&o.splice(r,1),this.setAllListConfig(o,t)}static setListConfig(e,t){let o=this.getAllListConfig(t);const r=o.indexOf(e);r>-1?(o.splice(r,1),o.unshift(e)):o.unshift(e),this.setAllListConfig(o,t)}static setAllListConfig(e,t,o=!0){this.setItem(t,JSON.stringify(e)),o&&this.setSyncRecord({type:"config",catergory:"listConfig",name:"general",key:t},{operation:"update",time:Date.now()})}static setObjectConfig(e,t,o,r=!0){let i=this.getAllObjectConfig(o);i[e]=t,r&&this.setSyncRecord({type:"config",catergory:"objectConfig",name:o,key:e},{operation:"update",time:Date.now()}),this.setAllObjectConfig(i,o)}static getObjectConfig(e,t,o){return this.getAllObjectConfig(t)[e]||o}static getAllObjectConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static setAllObjectConfig(e,t){this.setItem(t,JSON.stringify(e))}static deleteObjectConfig(e,t){let o=this.getAllObjectConfig(t);delete o[e],this.setSyncRecord({type:"config",catergory:"objectConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllObjectConfig(o,t)}static getAllMapConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static getMapConfig(e,t){return this.getAllMapConfig(t)[e]||[]}static setAllMapConfig(e,t){this.setItem(t,JSON.stringify(e))}static setMapConfig(e,t,o){let r=this.getAllMapConfig(o);void 0===r[e]&&(r[e]=[]),t&&-1===r[e].indexOf(t)&&r[e].unshift(t),this.setSyncRecord({type:"config",catergory:"mapConfig",name:o,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(r,o)}static setOneMapConfig(e,t,o,r=!0){let i=this.getAllMapConfig(o);i[e]=t,r&&this.setSyncRecord({type:"config",catergory:"mapConfig",name:o,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(i,o)}static deleteFromMapConfig(e,t,o){let r=this.getAllMapConfig(o),i=r[e].indexOf(t);r[e].splice(i,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:o,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(r,o)}static deleteFromAllMapConfig(e,t){let o=this.getAllMapConfig(t);Object.keys(o).forEach((r=>{let i=o[r].indexOf(e);i>-1&&(o[r].splice(i,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:r},{operation:"update",time:Date.now()}))})),this.setAllMapConfig(o,t)}static deleteMapConfig(e,t){let o=this.getAllMapConfig(t);delete o[e],this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllMapConfig(o,t)}static getFromAllMapConfig(e,t){let o=this.getAllMapConfig(t),r=[];for(let t in o)o[t]&&o[t].indexOf(e)>-1&&r.push(t);return r}static getSyncRecord(e){return JSON.parse(this.getItem("syncRecord")||"{}")[e.type+"."+e.catergory+"."+e.name+"."+e.key]||{operation:"",time:0}}static getAllSyncRecord(){return JSON.parse(this.getItem("syncRecord")||"{}")}static setSyncRecord(e,t){let o=JSON.parse(this.getItem("syncRecord")||"{}");o[e.type+"."+e.catergory+"."+e.name+"."+e.key]=t,this.setItem("syncRecord",JSON.stringify(o))}static setAllSyncRecord(e){this.setItem("syncRecord",JSON.stringify(e))}});var ee,te;let oe;const re=new Uint8Array(16);function ie(){if(!oe&&(oe="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!oe))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return oe(re)}const ne=[];for(let e=0;e<256;++e)ne.push((e+256).toString(16).slice(1));var ae={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function se(e,t,o){if(ae.randomUUID&&!t&&!e)return ae.randomUUID();const r=(e=e||{}).random||(e.rng||ie)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){o=o||0;for(let e=0;e<16;++e)t[o+e]=r[e];return t}return function(e,t=0){return ne[e[t+0]]+ne[e[t+1]]+ne[e[t+2]]+ne[e[t+3]]+"-"+ne[e[t+4]]+ne[e[t+5]]+"-"+ne[e[t+6]]+ne[e[t+7]]+"-"+ne[e[t+8]]+ne[e[t+9]]+"-"+ne[e[t+10]]+ne[e[t+11]]+ne[e[t+12]]+ne[e[t+13]]+ne[e[t+14]]+ne[e[t+15]]}(r)}class le{static saveAllToken(e){return a(this,void 0,void 0,(function*(){if(e)if(n){const{ipcRenderer:t}=window.require("electron");t.invoke("encrypt-data",{token:e})}else{const t=yield this.encryptString(e);localStorage.setItem("encryptedToken",t)}}))}static getAllToken(){return a(this,void 0,void 0,(function*(){if(n){const{ipcRenderer:e}=window.require("electron");return yield e.invoke("decrypt-data")}{let e=localStorage.getItem("encryptedToken")||"";return e?yield this.decryptString(e):null}}))}static setToken(e,t){return a(this,void 0,void 0,(function*(){const o=JSON.parse((yield this.getAllToken())||"{}");o[e]=t,yield this.saveAllToken(JSON.stringify(o))}))}static getToken(e){return a(this,void 0,void 0,(function*(){return JSON.parse((yield this.getAllToken())||"{}")[e]||null}))}static deleteToken(e){return a(this,void 0,void 0,(function*(){const t=JSON.parse((yield this.getAllToken())||"{}");delete t[e],yield this.saveAllToken(JSON.stringify(t))}))}static encryptString(e){return a(this,void 0,void 0,(function*(){try{let t=yield this.getFingerprint();const o=yield ue(t),r=yield function(e,t,o={alg:"HS256",typ:"JWT"}){return a(this,void 0,void 0,(function*(){const r=ce((new TextEncoder).encode(JSON.stringify(o))),i=ce((new TextEncoder).encode(JSON.stringify(e))),n=(new TextEncoder).encode(`${r}.${i}`),a=yield crypto.subtle.importKey("raw",(new TextEncoder).encode(t),{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return`${r}.${i}.${ce(yield crypto.subtle.sign("HMAC",a,n))}`}))}(e,o);return r}catch(e){return console.error("Error generating secret:",e),""}}))}static decryptString(e){return a(this,void 0,void 0,(function*(){try{let t=yield this.getFingerprint();console.log(t,"fingerprint");const o=yield ue(t),r=yield function(e,t){return a(this,void 0,void 0,(function*(){const[o,r,i]=e.split("."),n=(new TextEncoder).encode(`${o}.${r}`),a=yield de(i),s=yield crypto.subtle.importKey("raw",(new TextEncoder).encode(t),{name:"HMAC",hash:{name:"SHA-256"}},!1,["verify"]);if(!(yield crypto.subtle.verify("HMAC",s,a,n)))throw new Error("Invalid signature");return JSON.parse((new TextDecoder).decode(de(r)))}))}(e,o);return r}catch(e){return console.error("Error generating secret:",e),""}}))}static oldDecryptString(e){return a(this,void 0,void 0,(function*(){let t=yield this.getFingerprint();const o=yield crypto.subtle.digest("SHA-256",(new TextEncoder).encode(t)),r=yield crypto.subtle.importKey("raw",o,{name:"AES-GCM",length:256},!1,["decrypt"]),i=new Uint8Array(e.split("").map((e=>e.charCodeAt(0)))),n=i.slice(0,12),a=i.slice(12),s=yield crypto.subtle.decrypt({name:"AES-GCM",iv:n},r,a);return(new TextDecoder).decode(s)}))}static getFingerprint(){return a(this,void 0,void 0,(function*(){if(n){let e=yield this.getToken("device_uuid");if(e)return e;const{ipcRenderer:t}=window.require("electron");let o=yield t.invoke("get-mac");return yield this.setToken("device_uuid",o),o}{let e=Z.getItem("fingerPrint");if(e)return e;let t=se().replace(/-/g,"");return Z.setItem("fingerPrint",t),t}}))}}function ce(e){return btoa(String.fromCharCode.apply(null,Array.from(new Uint8Array(e)))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function de(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),o=atob(t),r=new Uint8Array(o.length);for(let e=0;e<o.length;e++)r[e]=o.charCodeAt(e);return r}function ue(e){return a(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e);return function(e){let t="";const o=new Uint8Array(e);for(let e=0;e<o.byteLength;e++)t+=String.fromCharCode(o[e]);return btoa(t)}(yield crypto.subtle.digest("SHA-256",t))}))}var pe="1.13.7",fe="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||Function("return this")()||{},he=Array.prototype,ge=Object.prototype,ye="undefined"!=typeof Symbol?Symbol.prototype:null,me=he.push,ve=he.slice,ke=ge.toString,be=ge.hasOwnProperty,we="undefined"!=typeof ArrayBuffer,Ee="undefined"!=typeof DataView,Ce=Array.isArray,Te=Object.keys,xe=Object.create,_e=we&&ArrayBuffer.isView,Se=isNaN,Re=isFinite,Ae=!{toString:null}.propertyIsEnumerable("toString"),Oe=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],Ie=Math.pow(2,53)-1;function Fe(e,t){return t=null==t?e.length-1:+t,function(){for(var o=Math.max(arguments.length-t,0),r=Array(o),i=0;i<o;i++)r[i]=arguments[i+t];switch(t){case 0:return e.call(this,r);case 1:return e.call(this,arguments[0],r);case 2:return e.call(this,arguments[0],arguments[1],r)}var n=Array(t+1);for(i=0;i<t;i++)n[i]=arguments[i];return n[t]=r,e.apply(this,n)}}function Le(e){var t=typeof e;return"function"===t||"object"===t&&!!e}function je(e){return void 0===e}function Be(e){return!0===e||!1===e||"[object Boolean]"===ke.call(e)}function Me(e){var t="[object "+e+"]";return function(e){return ke.call(e)===t}}var ze=Me("String"),De=Me("Number"),Ue=Me("Date"),Ne=Me("RegExp"),$e=Me("Error"),Pe=Me("Symbol"),qe=Me("ArrayBuffer"),We=Me("Function"),Ke=fe.document&&fe.document.childNodes;"function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof Ke&&(We=function(e){return"function"==typeof e||!1});var Je=We,He=Me("Object"),Ve=Ee&&(!/\[native code\]/.test(String(DataView))||He(new DataView(new ArrayBuffer(8)))),Xe="undefined"!=typeof Map&&He(new Map),Qe=Me("DataView");var Ye=Ve?function(e){return null!=e&&Je(e.getInt8)&&qe(e.buffer)}:Qe,Ge=Ce||Me("Array");function Ze(e,t){return null!=e&&be.call(e,t)}var et=Me("Arguments");!function(){et(arguments)||(et=function(e){return Ze(e,"callee")})}();var tt=et;function ot(e){return De(e)&&Se(e)}function rt(e){return function(){return e}}function it(e){return function(t){var o=e(t);return"number"==typeof o&&o>=0&&o<=Ie}}function nt(e){return function(t){return null==t?void 0:t[e]}}var at=nt("byteLength"),st=it(at),lt=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;var ct=we?function(e){return _e?_e(e)&&!Ye(e):st(e)&&lt.test(ke.call(e))}:rt(!1),dt=nt("length");function ut(e,t){t=function(e){for(var t={},o=e.length,r=0;r<o;++r)t[e[r]]=!0;return{contains:function(e){return!0===t[e]},push:function(o){return t[o]=!0,e.push(o)}}}(t);var o=Oe.length,r=e.constructor,i=Je(r)&&r.prototype||ge,n="constructor";for(Ze(e,n)&&!t.contains(n)&&t.push(n);o--;)(n=Oe[o])in e&&e[n]!==i[n]&&!t.contains(n)&&t.push(n)}function pt(e){if(!Le(e))return[];if(Te)return Te(e);var t=[];for(var o in e)Ze(e,o)&&t.push(o);return Ae&&ut(e,t),t}function ft(e,t){var o=pt(t),r=o.length;if(null==e)return!r;for(var i=Object(e),n=0;n<r;n++){var a=o[n];if(t[a]!==i[a]||!(a in i))return!1}return!0}function ht(e){return e instanceof ht?e:this instanceof ht?void(this._wrapped=e):new ht(e)}function gt(e){return new Uint8Array(e.buffer||e,e.byteOffset||0,at(e))}ht.VERSION=pe,ht.prototype.value=function(){return this._wrapped},ht.prototype.valueOf=ht.prototype.toJSON=ht.prototype.value,ht.prototype.toString=function(){return String(this._wrapped)};var yt="[object DataView]";function mt(e,t,o,r){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return!1;if(e!=e)return t!=t;var i=typeof e;return("function"===i||"object"===i||"object"==typeof t)&&vt(e,t,o,r)}function vt(e,t,o,r){e instanceof ht&&(e=e._wrapped),t instanceof ht&&(t=t._wrapped);var i=ke.call(e);if(i!==ke.call(t))return!1;if(Ve&&"[object Object]"==i&&Ye(e)){if(!Ye(t))return!1;i=yt}switch(i){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!=+e?+t!=+t:0==+e?1/+e==1/t:+e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object Symbol]":return ye.valueOf.call(e)===ye.valueOf.call(t);case"[object ArrayBuffer]":case yt:return vt(gt(e),gt(t),o,r)}var n="[object Array]"===i;if(!n&&ct(e)){if(at(e)!==at(t))return!1;if(e.buffer===t.buffer&&e.byteOffset===t.byteOffset)return!0;n=!0}if(!n){if("object"!=typeof e||"object"!=typeof t)return!1;var a=e.constructor,s=t.constructor;if(a!==s&&!(Je(a)&&a instanceof a&&Je(s)&&s instanceof s)&&"constructor"in e&&"constructor"in t)return!1}r=r||[];for(var l=(o=o||[]).length;l--;)if(o[l]===e)return r[l]===t;if(o.push(e),r.push(t),n){if((l=e.length)!==t.length)return!1;for(;l--;)if(!mt(e[l],t[l],o,r))return!1}else{var c,d=pt(e);if(l=d.length,pt(t).length!==l)return!1;for(;l--;)if(!Ze(t,c=d[l])||!mt(e[c],t[c],o,r))return!1}return o.pop(),r.pop(),!0}function kt(e){if(!Le(e))return[];var t=[];for(var o in e)t.push(o);return Ae&&ut(e,t),t}function bt(e){var t=dt(e);return function(o){if(null==o)return!1;var r=kt(o);if(dt(r))return!1;for(var i=0;i<t;i++)if(!Je(o[e[i]]))return!1;return e!==xt||!Je(o[wt])}}var wt="forEach",Et=["clear","delete"],Ct=["get","has","set"],Tt=Et.concat(wt,Ct),xt=Et.concat(Ct),_t=["add"].concat(Et,wt,"has"),St=Xe?bt(Tt):Me("Map"),Rt=Xe?bt(xt):Me("WeakMap"),At=Xe?bt(_t):Me("Set"),Ot=Me("WeakSet");function It(e){for(var t=pt(e),o=t.length,r=Array(o),i=0;i<o;i++)r[i]=e[t[i]];return r}function Ft(e){for(var t={},o=pt(e),r=0,i=o.length;r<i;r++)t[e[o[r]]]=o[r];return t}function Lt(e){var t=[];for(var o in e)Je(e[o])&&t.push(o);return t.sort()}function jt(e,t){return function(o){var r=arguments.length;if(t&&(o=Object(o)),r<2||null==o)return o;for(var i=1;i<r;i++)for(var n=arguments[i],a=e(n),s=a.length,l=0;l<s;l++){var c=a[l];t&&void 0!==o[c]||(o[c]=n[c])}return o}}var Bt=jt(kt),Mt=jt(pt),zt=jt(kt,!0);function Dt(e){if(!Le(e))return{};if(xe)return xe(e);var t=function(){};t.prototype=e;var o=new t;return t.prototype=null,o}function Ut(e){return Ge(e)?e:[e]}function Nt(e){return ht.toPath(e)}function $t(e,t){for(var o=t.length,r=0;r<o;r++){if(null==e)return;e=e[t[r]]}return o?e:void 0}function Pt(e,t,o){var r=$t(e,Nt(t));return je(r)?o:r}function qt(e){return e}function Wt(e){return e=Mt({},e),function(t){return ft(t,e)}}function Kt(e){return e=Nt(e),function(t){return $t(t,e)}}function Jt(e,t,o){if(void 0===t)return e;switch(null==o?3:o){case 1:return function(o){return e.call(t,o)};case 3:return function(o,r,i){return e.call(t,o,r,i)};case 4:return function(o,r,i,n){return e.call(t,o,r,i,n)}}return function(){return e.apply(t,arguments)}}function Ht(e,t,o){return null==e?qt:Je(e)?Jt(e,t,o):Le(e)&&!Ge(e)?Wt(e):Kt(e)}function Vt(e,t){return Ht(e,t,1/0)}function Xt(e,t,o){return ht.iteratee!==Vt?ht.iteratee(e,t):Ht(e,t,o)}function Qt(){}function Yt(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))}ht.toPath=Ut,ht.iteratee=Vt;var Gt=Date.now||function(){return(new Date).getTime()};function Zt(e){var t=function(t){return e[t]},o="(?:"+pt(e).join("|")+")",r=RegExp(o),i=RegExp(o,"g");return function(e){return e=null==e?"":""+e,r.test(e)?e.replace(i,t):e}}var eo={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},to=Zt(eo),oo=Zt(Ft(eo)),ro=ht.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},io=/(.)^/,no={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},ao=/\\|'|\r|\n|\u2028|\u2029/g;function so(e){return"\\"+no[e]}var lo=/^\s*(\w|\$)+\s*$/;var co=0;function uo(e,t,o,r,i){if(!(r instanceof t))return e.apply(o,i);var n=Dt(e.prototype),a=e.apply(n,i);return Le(a)?a:n}var po=Fe((function(e,t){var o=po.placeholder,r=function(){for(var i=0,n=t.length,a=Array(n),s=0;s<n;s++)a[s]=t[s]===o?arguments[i++]:t[s];for(;i<arguments.length;)a.push(arguments[i++]);return uo(e,r,this,this,a)};return r}));po.placeholder=ht;var fo=Fe((function(e,t,o){if(!Je(e))throw new TypeError("Bind must be called on a function");var r=Fe((function(i){return uo(e,r,t,this,o.concat(i))}));return r})),ho=it(dt);function go(e,t,o,r){if(r=r||[],t||0===t){if(t<=0)return r.concat(e)}else t=1/0;for(var i=r.length,n=0,a=dt(e);n<a;n++){var s=e[n];if(ho(s)&&(Ge(s)||tt(s)))if(t>1)go(s,t-1,o,r),i=r.length;else for(var l=0,c=s.length;l<c;)r[i++]=s[l++];else o||(r[i++]=s)}return r}var yo=Fe((function(e,t){var o=(t=go(t,!1,!1)).length;if(o<1)throw new Error("bindAll must be passed function names");for(;o--;){var r=t[o];e[r]=fo(e[r],e)}return e}));var mo=Fe((function(e,t,o){return setTimeout((function(){return e.apply(null,o)}),t)})),vo=po(mo,ht,1);function ko(e){return function(){return!e.apply(this,arguments)}}function bo(e,t){var o;return function(){return--e>0&&(o=t.apply(this,arguments)),e<=1&&(t=null),o}}var wo=po(bo,2);function Eo(e,t,o){t=Xt(t,o);for(var r,i=pt(e),n=0,a=i.length;n<a;n++)if(t(e[r=i[n]],r,e))return r}function Co(e){return function(t,o,r){o=Xt(o,r);for(var i=dt(t),n=e>0?0:i-1;n>=0&&n<i;n+=e)if(o(t[n],n,t))return n;return-1}}var To=Co(1),xo=Co(-1);function _o(e,t,o,r){for(var i=(o=Xt(o,r,1))(t),n=0,a=dt(e);n<a;){var s=Math.floor((n+a)/2);o(e[s])<i?n=s+1:a=s}return n}function So(e,t,o){return function(r,i,n){var a=0,s=dt(r);if("number"==typeof n)e>0?a=n>=0?n:Math.max(n+s,a):s=n>=0?Math.min(n+1,s):n+s+1;else if(o&&n&&s)return r[n=o(r,i)]===i?n:-1;if(i!=i)return(n=t(ve.call(r,a,s),ot))>=0?n+a:-1;for(n=e>0?a:s-1;n>=0&&n<s;n+=e)if(r[n]===i)return n;return-1}}var Ro=So(1,To,_o),Ao=So(-1,xo);function Oo(e,t,o){var r=(ho(e)?To:Eo)(e,t,o);if(void 0!==r&&-1!==r)return e[r]}function Io(e,t,o){var r,i;if(t=Jt(t,o),ho(e))for(r=0,i=e.length;r<i;r++)t(e[r],r,e);else{var n=pt(e);for(r=0,i=n.length;r<i;r++)t(e[n[r]],n[r],e)}return e}function Fo(e,t,o){t=Xt(t,o);for(var r=!ho(e)&&pt(e),i=(r||e).length,n=Array(i),a=0;a<i;a++){var s=r?r[a]:a;n[a]=t(e[s],s,e)}return n}function Lo(e){return function(t,o,r,i){var n=arguments.length>=3;return function(t,o,r,i){var n=!ho(t)&&pt(t),a=(n||t).length,s=e>0?0:a-1;for(i||(r=t[n?n[s]:s],s+=e);s>=0&&s<a;s+=e){var l=n?n[s]:s;r=o(r,t[l],l,t)}return r}(t,Jt(o,i,4),r,n)}}var jo=Lo(1),Bo=Lo(-1);function Mo(e,t,o){var r=[];return t=Xt(t,o),Io(e,(function(e,o,i){t(e,o,i)&&r.push(e)})),r}function zo(e,t,o){t=Xt(t,o);for(var r=!ho(e)&&pt(e),i=(r||e).length,n=0;n<i;n++){var a=r?r[n]:n;if(!t(e[a],a,e))return!1}return!0}function Do(e,t,o){t=Xt(t,o);for(var r=!ho(e)&&pt(e),i=(r||e).length,n=0;n<i;n++){var a=r?r[n]:n;if(t(e[a],a,e))return!0}return!1}function Uo(e,t,o,r){return ho(e)||(e=It(e)),("number"!=typeof o||r)&&(o=0),Ro(e,t,o)>=0}var No=Fe((function(e,t,o){var r,i;return Je(t)?i=t:(t=Nt(t),r=t.slice(0,-1),t=t[t.length-1]),Fo(e,(function(e){var n=i;if(!n){if(r&&r.length&&(e=$t(e,r)),null==e)return;n=e[t]}return null==n?n:n.apply(e,o)}))}));function $o(e,t){return Fo(e,Kt(t))}function Po(e,t,o){var r,i,n=-1/0,a=-1/0;if(null==t||"number"==typeof t&&"object"!=typeof e[0]&&null!=e)for(var s=0,l=(e=ho(e)?e:It(e)).length;s<l;s++)null!=(r=e[s])&&r>n&&(n=r);else t=Xt(t,o),Io(e,(function(e,o,r){((i=t(e,o,r))>a||i===-1/0&&n===-1/0)&&(n=e,a=i)}));return n}var qo=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function Wo(e){return e?Ge(e)?ve.call(e):ze(e)?e.match(qo):ho(e)?Fo(e,qt):It(e):[]}function Ko(e,t,o){if(null==t||o)return ho(e)||(e=It(e)),e[Yt(e.length-1)];var r=Wo(e),i=dt(r);t=Math.max(Math.min(t,i),0);for(var n=i-1,a=0;a<t;a++){var s=Yt(a,n),l=r[a];r[a]=r[s],r[s]=l}return r.slice(0,t)}function Jo(e,t){return function(o,r,i){var n=t?[[],[]]:{};return r=Xt(r,i),Io(o,(function(t,i){var a=r(t,i,o);e(n,t,a)})),n}}var Ho=Jo((function(e,t,o){Ze(e,o)?e[o].push(t):e[o]=[t]})),Vo=Jo((function(e,t,o){e[o]=t})),Xo=Jo((function(e,t,o){Ze(e,o)?e[o]++:e[o]=1})),Qo=Jo((function(e,t,o){e[o?0:1].push(t)}),!0);function Yo(e,t,o){return t in o}var Go=Fe((function(e,t){var o={},r=t[0];if(null==e)return o;Je(r)?(t.length>1&&(r=Jt(r,t[1])),t=kt(e)):(r=Yo,t=go(t,!1,!1),e=Object(e));for(var i=0,n=t.length;i<n;i++){var a=t[i],s=e[a];r(s,a,e)&&(o[a]=s)}return o})),Zo=Fe((function(e,t){var o,r=t[0];return Je(r)?(r=ko(r),t.length>1&&(o=t[1])):(t=Fo(go(t,!1,!1),String),r=function(e,o){return!Uo(t,o)}),Go(e,r,o)}));function er(e,t,o){return ve.call(e,0,Math.max(0,e.length-(null==t||o?1:t)))}function tr(e,t,o){return null==e||e.length<1?null==t||o?void 0:[]:null==t||o?e[0]:er(e,e.length-t)}function or(e,t,o){return ve.call(e,null==t||o?1:t)}var rr=Fe((function(e,t){return t=go(t,!0,!0),Mo(e,(function(e){return!Uo(t,e)}))})),ir=Fe((function(e,t){return rr(e,t)}));function nr(e,t,o,r){Be(t)||(r=o,o=t,t=!1),null!=o&&(o=Xt(o,r));for(var i=[],n=[],a=0,s=dt(e);a<s;a++){var l=e[a],c=o?o(l,a,e):l;t&&!o?(a&&n===c||i.push(l),n=c):o?Uo(n,c)||(n.push(c),i.push(l)):Uo(i,l)||i.push(l)}return i}var ar=Fe((function(e){return nr(go(e,!0,!0))}));function sr(e){for(var t=e&&Po(e,dt).length||0,o=Array(t),r=0;r<t;r++)o[r]=$o(e,r);return o}var lr=Fe(sr);function cr(e,t){return e._chain?ht(t).chain():t}function dr(e){return Io(Lt(e),(function(t){var o=ht[t]=e[t];ht.prototype[t]=function(){var e=[this._wrapped];return me.apply(e,arguments),cr(this,o.apply(ht,e))}})),ht}Io(["pop","push","reverse","shift","sort","splice","unshift"],(function(e){var t=he[e];ht.prototype[e]=function(){var o=this._wrapped;return null!=o&&(t.apply(o,arguments),"shift"!==e&&"splice"!==e||0!==o.length||delete o[0]),cr(this,o)}})),Io(["concat","join","slice"],(function(e){var t=he[e];ht.prototype[e]=function(){var e=this._wrapped;return null!=e&&(e=t.apply(e,arguments)),cr(this,e)}}));var ur=Object.freeze({__proto__:null,VERSION:pe,restArguments:Fe,isObject:Le,isNull:function(e){return null===e},isUndefined:je,isBoolean:Be,isElement:function(e){return!(!e||1!==e.nodeType)},isString:ze,isNumber:De,isDate:Ue,isRegExp:Ne,isError:$e,isSymbol:Pe,isArrayBuffer:qe,isDataView:Ye,isArray:Ge,isFunction:Je,isArguments:tt,isFinite:function(e){return!Pe(e)&&Re(e)&&!isNaN(parseFloat(e))},isNaN:ot,isTypedArray:ct,isEmpty:function(e){if(null==e)return!0;var t=dt(e);return"number"==typeof t&&(Ge(e)||ze(e)||tt(e))?0===t:0===dt(pt(e))},isMatch:ft,isEqual:function(e,t){return mt(e,t)},isMap:St,isWeakMap:Rt,isSet:At,isWeakSet:Ot,keys:pt,allKeys:kt,values:It,pairs:function(e){for(var t=pt(e),o=t.length,r=Array(o),i=0;i<o;i++)r[i]=[t[i],e[t[i]]];return r},invert:Ft,functions:Lt,methods:Lt,extend:Bt,extendOwn:Mt,assign:Mt,defaults:zt,create:function(e,t){var o=Dt(e);return t&&Mt(o,t),o},clone:function(e){return Le(e)?Ge(e)?e.slice():Bt({},e):e},tap:function(e,t){return t(e),e},get:Pt,has:function(e,t){for(var o=(t=Nt(t)).length,r=0;r<o;r++){var i=t[r];if(!Ze(e,i))return!1;e=e[i]}return!!o},mapObject:function(e,t,o){t=Xt(t,o);for(var r=pt(e),i=r.length,n={},a=0;a<i;a++){var s=r[a];n[s]=t(e[s],s,e)}return n},identity:qt,constant:rt,noop:Qt,toPath:Ut,property:Kt,propertyOf:function(e){return null==e?Qt:function(t){return Pt(e,t)}},matcher:Wt,matches:Wt,times:function(e,t,o){var r=Array(Math.max(0,e));t=Jt(t,o,1);for(var i=0;i<e;i++)r[i]=t(i);return r},random:Yt,now:Gt,escape:to,unescape:oo,templateSettings:ro,template:function(e,t,o){!t&&o&&(t=o),t=zt({},t,ht.templateSettings);var r=RegExp([(t.escape||io).source,(t.interpolate||io).source,(t.evaluate||io).source].join("|")+"|$","g"),i=0,n="__p+='";e.replace(r,(function(t,o,r,a,s){return n+=e.slice(i,s).replace(ao,so),i=s+t.length,o?n+="'+\n((__t=("+o+"))==null?'':_.escape(__t))+\n'":r?n+="'+\n((__t=("+r+"))==null?'':__t)+\n'":a&&(n+="';\n"+a+"\n__p+='"),t})),n+="';\n";var a,s=t.variable;if(s){if(!lo.test(s))throw new Error("variable is not a bare identifier: "+s)}else n="with(obj||{}){\n"+n+"}\n",s="obj";n="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+n+"return __p;\n";try{a=new Function(s,"_",n)}catch(e){throw e.source=n,e}var l=function(e){return a.call(this,e,ht)};return l.source="function("+s+"){\n"+n+"}",l},result:function(e,t,o){var r=(t=Nt(t)).length;if(!r)return Je(o)?o.call(e):o;for(var i=0;i<r;i++){var n=null==e?void 0:e[t[i]];void 0===n&&(n=o,i=r),e=Je(n)?n.call(e):n}return e},uniqueId:function(e){var t=++co+"";return e?e+t:t},chain:function(e){var t=ht(e);return t._chain=!0,t},iteratee:Vt,partial:po,bind:fo,bindAll:yo,memoize:function(e,t){var o=function(r){var i=o.cache,n=""+(t?t.apply(this,arguments):r);return Ze(i,n)||(i[n]=e.apply(this,arguments)),i[n]};return o.cache={},o},delay:mo,defer:vo,throttle:function(e,t,o){var r,i,n,a,s=0;o||(o={});var l=function(){s=!1===o.leading?0:Gt(),r=null,a=e.apply(i,n),r||(i=n=null)},c=function(){var c=Gt();s||!1!==o.leading||(s=c);var d=t-(c-s);return i=this,n=arguments,d<=0||d>t?(r&&(clearTimeout(r),r=null),s=c,a=e.apply(i,n),r||(i=n=null)):r||!1===o.trailing||(r=setTimeout(l,d)),a};return c.cancel=function(){clearTimeout(r),s=0,r=i=n=null},c},debounce:function(e,t,o){var r,i,n,a,s,l=function(){var c=Gt()-i;t>c?r=setTimeout(l,t-c):(r=null,o||(a=e.apply(s,n)),r||(n=s=null))},c=Fe((function(c){return s=this,n=c,i=Gt(),r||(r=setTimeout(l,t),o&&(a=e.apply(s,n))),a}));return c.cancel=function(){clearTimeout(r),r=n=s=null},c},wrap:function(e,t){return po(t,e)},negate:ko,compose:function(){var e=arguments,t=e.length-1;return function(){for(var o=t,r=e[t].apply(this,arguments);o--;)r=e[o].call(this,r);return r}},after:function(e,t){return function(){if(--e<1)return t.apply(this,arguments)}},before:bo,once:wo,findKey:Eo,findIndex:To,findLastIndex:xo,sortedIndex:_o,indexOf:Ro,lastIndexOf:Ao,find:Oo,detect:Oo,findWhere:function(e,t){return Oo(e,Wt(t))},each:Io,forEach:Io,map:Fo,collect:Fo,reduce:jo,foldl:jo,inject:jo,reduceRight:Bo,foldr:Bo,filter:Mo,select:Mo,reject:function(e,t,o){return Mo(e,ko(Xt(t)),o)},every:zo,all:zo,some:Do,any:Do,contains:Uo,includes:Uo,include:Uo,invoke:No,pluck:$o,where:function(e,t){return Mo(e,Wt(t))},max:Po,min:function(e,t,o){var r,i,n=1/0,a=1/0;if(null==t||"number"==typeof t&&"object"!=typeof e[0]&&null!=e)for(var s=0,l=(e=ho(e)?e:It(e)).length;s<l;s++)null!=(r=e[s])&&r<n&&(n=r);else t=Xt(t,o),Io(e,(function(e,o,r){((i=t(e,o,r))<a||i===1/0&&n===1/0)&&(n=e,a=i)}));return n},shuffle:function(e){return Ko(e,1/0)},sample:Ko,sortBy:function(e,t,o){var r=0;return t=Xt(t,o),$o(Fo(e,(function(e,o,i){return{value:e,index:r++,criteria:t(e,o,i)}})).sort((function(e,t){var o=e.criteria,r=t.criteria;if(o!==r){if(o>r||void 0===o)return 1;if(o<r||void 0===r)return-1}return e.index-t.index})),"value")},groupBy:Ho,indexBy:Vo,countBy:Xo,partition:Qo,toArray:Wo,size:function(e){return null==e?0:ho(e)?e.length:pt(e).length},pick:Go,omit:Zo,first:tr,head:tr,take:tr,initial:er,last:function(e,t,o){return null==e||e.length<1?null==t||o?void 0:[]:null==t||o?e[e.length-1]:or(e,Math.max(0,e.length-t))},rest:or,tail:or,drop:or,compact:function(e){return Mo(e,Boolean)},flatten:function(e,t){return go(e,t,!1)},without:ir,uniq:nr,unique:nr,union:ar,intersection:function(e){for(var t=[],o=arguments.length,r=0,i=dt(e);r<i;r++){var n=e[r];if(!Uo(t,n)){var a;for(a=1;a<o&&Uo(arguments[a],n);a++);a===o&&t.push(n)}}return t},difference:rr,unzip:sr,transpose:sr,zip:lr,object:function(e,t){for(var o={},r=0,i=dt(e);r<i;r++)t?o[e[r]]=t[r]:o[e[r][0]]=e[r][1];return o},range:function(e,t,o){null==t&&(t=e||0,e=0),o||(o=t<e?-1:1);for(var r=Math.max(Math.ceil((t-e)/o),0),i=Array(r),n=0;n<r;n++,e+=o)i[n]=e;return i},chunk:function(e,t){if(null==t||t<1)return[];for(var o=[],r=0,i=e.length;r<i;)o.push(ve.call(e,r,r+=t));return o},mixin:dr,default:ht}),pr=dr(ur);pr._=pr;const fr=e=>e.map((e=>e.name)),hr=e=>e.map((e=>e.key)),gr=(e,t)=>{let o=[];for(let r=0;r<e.length;r++)t.indexOf(e[r])>-1&&o.push(t.indexOf(e[r]));return o.length<t.length&&t.forEach((r=>{if(-1===e.indexOf(r))for(let e=0;e<t.length;e++)if(-1===o.indexOf(e)){o.push(e);break}})),[...new Set(o.map((e=>e-Math.min(...o))))]};class yr{static sortBooks(e,t,o){let r=e.map((e=>e.key)),i=(e=>e.getAllListConfig("recentBooks"))(o);if(1===t.sort||0===t.sort)return 1===t.order?gr(i,r).reverse():gr(i,r);if(2===t.sort){let o=fr(e),r=fr(e).sort();return 1===t.order?gr(r,o).reverse():gr(r,o)}if(3===t.sort){let o=[];for(let t=0;t<e.length;t++)o.push(t);return 1===t.order?o.reverse():o}if(4===t.sort){let r=(e=>{let t=e.getAllObjectConfig("readingTime");var o=[];for(let e in t)o.push([e,t[e]]);return o.sort((function(e,t){return e[1]-t[1]})),Object.keys(t)})(o),i=hr(e);return 1===t.order?gr(pr.union(r,i),i).reverse():gr(pr.union(r,i),i)}if(5===t.sort){let o=hr(e),r=(e=>pr.sortBy(e.map((e=>({key:e.key,author:e.author}))),"author").map((e=>e.key)))(e);return 1===t.order?gr(r,o).reverse():gr(r,o)}if(6===t.sort){let r=(e=>{let t=e.getAllObjectConfig("recordLocation");var o=[];for(let e in t)o.push([e,t[e].percentage||0]);return o.sort((function(e,t){return e[1]-t[1]})),o.map((e=>e[0]))})(o),i=hr(e);return 1===t.order?gr(r,i).reverse():gr(r,i)}}static sortNotes(e,t,o=[]){if(3===t.sort){let o=pr.clone(e).reverse(),r=pr.uniq(e.map((e=>({chapter:e.chapter,chapterIndex:e.chapterIndex}))));r=1===t.order?pr.sortBy(r,"chapterIndex"):pr.sortBy(r,"chapterIndex").reverse();let i=pr.uniq(r.map((e=>e.chapter))),n={};return i.forEach((e=>{n[e]=[]})),o.forEach((e=>{n[e.chapter].push(e)})),i.map((e=>({group:e,notes:n[e]})))||[]}if(2===t.sort){let o=pr.clone(e).reverse(),r=pr.uniq(e.map((e=>e.date.year+"-"+e.date.month+"-"+e.date.day)));1===t.order?r.sort():r.sort().reverse();let i={};return r.forEach((e=>{i[e]=[]})),o.forEach((e=>{r.forEach((t=>{t===e.date.year+"-"+e.date.month+"-"+e.date.day&&i[t].push(e)}))})),i||{}}if(1===t.sort){let r=pr.clone(e).reverse(),i=pr.uniq(e.map((e=>{let t=pr.findLastIndex(o,{key:e.bookKey});return t>-1?o[t].name:""})));1===t.order?i.sort():i.sort().reverse();let n={};return i.forEach((e=>{n[e]=[]})),r.forEach((e=>{i.forEach((t=>{let r=pr.findLastIndex(o,{key:e.bookKey});r>-1&&t===o[r].name&&n[t].push(e)}))})),n||{}}}static sortBookmarks(e,t){if(3===t.sort){let o=pr.clone(e).reverse(),r=pr.uniq(e.map((e=>({chapter:e.chapter,chapterIndex:parseInt(JSON.parse(e.cfi).chapterDocIndex)}))));r=1===t.order?pr.sortBy(r,"chapterIndex"):pr.sortBy(r,"chapterIndex").reverse();let i=pr.uniq(r.map((e=>e.chapter))),n={};return i.forEach((e=>{n[e]=[]})),o.forEach((e=>{n[e.chapter].push(e)})),i.map((e=>({group:e,bookmarks:n[e]})))||[]}}}class mr{static getDefaultCss(e,t=!1){return`::selection{background:#f3a6a68c}::-moz-selection{background:#f3a6a68c}.kookit-note:hover{cursor:pointer;}img{max-width:100% !important}.kookit-text{${this.getCustomCss(e,t)}}code,pre{white-space: pre-wrap;}`}static getCustomCss(e,t=!1){return`font-size: ${e.getReaderConfig("fontSize")?e.getReaderConfig("fontSize"):t?"60":"18"}px !important;line-height: ${e.getReaderConfig("lineHeight")||"1.25"} !important;font-family: ${e.getReaderConfig("fontFamily")||""} !important;background-color: transparent;color: ${e.getReaderConfig("textColor")?e.getReaderConfig("textColor"):"rgba(44,47,49,1)"===e.getReaderConfig("backgroundColor")||"night"===e.getReaderConfig("appSkin")||"system"===e.getReaderConfig("appSkin")&&"yes"===e.getReaderConfig("isOSNight")?"white":""} !important;letter-spacing: ${e.getReaderConfig("letterSpacing")?e.getReaderConfig("letterSpacing"):""}px !important;text-align: ${e.getReaderConfig("textAlign")?e.getReaderConfig("textAlign"):""} !important;font-weight: ${"yes"===e.getReaderConfig("isBold")?"bold !important":""};font-style: ${"yes"===e.getReaderConfig("isItalic")?"italic !important":""};text-shadow: ${"yes"===e.getReaderConfig("isShadow")?"2px 2px 2px #cccccc !important":""};text-indent: ${"yes"===e.getReaderConfig("isIndent")?"2rem":""};text-decoration: ${"yes"===e.getReaderConfig("isUnderline")?"underline !important":""};margin-bottom: ${e.getReaderConfig("paraSpacing")||0}px !important;padding:0px !important;word-wrap: break-word !important; writing-mode: horizontal-tb !important;`}}class vr{static mergeArray(e,t){var o=[];for(let t of e)o.push(t);for(let i of t){var r=!0;for(let t of e)if(i===t){r=!1;break}r&&o.push(i)}return o}static fuzzyQuery(e,t){for(var o=[],r=0;r<e.length;r++)e[r].indexOf(t.trim())>-1&&o.push(r);return o}static mouseSearch(e){let t=document.querySelector(".header-search-box").value.toLowerCase(),o=[],r=[];if(!e)return[];e.forEach((e=>{o.push(e.name.toLowerCase()),r.push(e.author.toLowerCase())}));let i=this.fuzzyQuery(o,t),n=this.fuzzyQuery(r,t);return this.mergeArray(i,n)}static keywordSearch(e,t){let o=[],r=[];if(!t)return[];t.forEach((e=>{o.push(e.name.toLowerCase()),r.push(e.author.toLowerCase())}));let i=this.fuzzyQuery(o,e),n=this.fuzzyQuery(r,e);return this.mergeArray(i,n)}static keySearch(e,t){if(e&&13===e.keyCode){let o=[],r=[];if(!t)return[];t.forEach((e=>{o.push(e.name.toLowerCase()),r.push(e.author.toLowerCase())}));let i=this.fuzzyQuery(o,e.target.value.toLowerCase()),n=this.fuzzyQuery(r,e.target.value.toLowerCase());return this.mergeArray(i,n)}}static mouseNoteSearch(e){let t=document.querySelector(".header-search-box").value.toLowerCase(),o=[],r=[];e.forEach((e=>{o.push(e.notes.toLowerCase()),r.push(e.text.toLowerCase())}));let i=this.fuzzyQuery(o,t),n=this.fuzzyQuery(r,t);return this.mergeArray(i,n)}static keyNoteSearch(e,t){if(e&&13===e.keyCode){let o=[],r=[];t.forEach((e=>{o.push(e.notes.toLowerCase()),r.push(e.text.toLowerCase())}));let i=this.fuzzyQuery(o,e.target.value.toLowerCase()),n=this.fuzzyQuery(r,e.target.value.toLowerCase());return this.mergeArray(i,n)}}}export{W as BookHelper,E as CommonTool,Z as ConfigService,c as KookitConfig,Q as LoginHelper,K as ReaderRequest,vr as SearchUtil,yr as SortUtil,P as SqlStatement,mr as StyleHelper,G as SyncHelper,B as SyncUtil,V as ThirdpartyRequest,le as TokenService,X as UserRequest};
